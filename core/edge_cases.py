"""
VERITAS v159 - Edge Case Patterns
エッジケース検出モジュール

「明示的」ではないが実質的に危険な条項を検出
婉曲表現、暗黙の同意擬制、証明責任転換等

設計原則:
- FALSE_OK=0 の死守
- 「一切」「いかなる」を使わない巧妙な免責を捕捉
"""

import re
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
from enum import Enum


class EdgeVerdict(Enum):
    """エッジケース判定結果"""
    NG_CRITICAL = "NG_CRITICAL"
    NG = "NG"
    REVIEW_HIGH = "REVIEW_HIGH"
    REVIEW_MED = "REVIEW_MED"


@dataclass
class EdgeCaseResult:
    """エッジケース検出結果"""
    verdict: EdgeVerdict
    trigger_name: str
    matched_text: str
    risk_explanation: str
    check_points: List[str]
    legal_basis: str
    rewrite_suggestion: Optional[str] = None


# =============================================================================
# 婉曲免責パターン（「一切」「いかなる」なしの免責）
# =============================================================================

EUPHEMISTIC_WAIVER_PATTERNS = {
    # 「責任を負いません」系（限定語なし）
    "bare_no_liability": {
        "pattern": r"(当社|甲|弊社|事業者).{0,15}(責任を負いません|責任を負わない|免責とします|免責とする)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "限定語なしの免責条項。「一切」と明示していないが実質的に全面免責の可能性",
        "check_points": [
            "免責の範囲が不明確",
            "故意・重過失の除外がない可能性",
            "消費者契約法8条違反リスク"
        ],
        "legal_basis": "消費者契約法8条",
        "rewrite": "「当社の故意または重過失による場合を除き、○○の範囲で責任を負わないものとします」",
        # 緩和条件: 故意・重過失の除外がある場合は別途context_awareで判定
        "exclude_if_contains": ["故意", "重過失", "除く", "限り"]
    },
    
    # 「損害が生じても」系
    "damage_occurs_no_liability": {
        "pattern": r"(損害|損失|不利益).{0,10}(生じ|発生し|被っ).{0,15}(責任を負|賠償し|補償し).{0,5}(ない|ません)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "損害発生を前提とした免責。事後的な責任逃れの意図が疑われる",
        "check_points": [
            "損害の種類・範囲が限定されていない",
            "因果関係の有無に関わらず免責している可能性",
            "信義則違反の可能性"
        ],
        "legal_basis": "民法1条2項（信義則）、消費者契約法8条",
        "rewrite": "「当社の責に帰すべき事由による損害については、○○を上限として賠償します」"
    },
    
    # 「保証するものではありません」系
    "no_guarantee_clause": {
        "pattern": r"(保証|担保|約束).{0,10}(するもの|しているもの).{0,5}(ではありません|ではない)",
        "verdict": EdgeVerdict.REVIEW_MED,
        "risk_explanation": "サービス品質・結果の保証を否定。過度に広い場合は問題",
        "check_points": [
            "何について保証しないのか確認",
            "契約の本旨に反しないか確認",
            "合理的期待を裏切らないか確認"
        ],
        "legal_basis": "民法415条（債務不履行）",
        "rewrite": "「○○については保証の対象外とします。ただし、△△については保証します」"
    },
}


# =============================================================================
# 暗黙の同意擬制パターン
# =============================================================================

IMPLIED_CONSENT_PATTERNS = {
    # 「利用をもって同意」系
    "use_equals_consent": {
        "pattern": r"(利用|使用|アクセス|登録).{0,10}(をもって|により|した時点で|することで).{0,10}(同意|承諾|合意).{0,10}(したもの|したこと).{0,5}(とみなし|と見なし|として扱)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "サービス利用を同意とみなす条項。重要事項への明示的同意なく拘束される危険",
        "check_points": [
            "同意対象が不明確",
            "将来の規約変更にも適用される可能性",
            "消費者契約法10条で無効となり得る"
        ],
        "legal_basis": "消費者契約法10条、民法548条の2",
        "rewrite": "「本サービスの利用開始前に、利用規約の内容をご確認の上、同意ボタンをクリックしてください」"
    },
    
    # 「異議なき場合は同意」系
    "silence_equals_consent": {
        "pattern": r"(異議|反対|申出).{0,10}(ない|なき|なかった).{0,15}(場合|ときは?).{0,15}(同意|承諾|承認).{0,10}(した|みなし|として)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "沈黙を同意とみなす条項。民法の原則に反する",
        "check_points": [
            "沈黙は原則として同意を意味しない（民法の原則）",
            "一方的に法律関係を変更できてしまう",
            "消費者契約法10条で無効"
        ],
        "legal_basis": "民法526条参照、消費者契約法10条",
        "rewrite": "「変更に同意いただけない場合は、○日以内に書面にてお知らせください。同意いただけない場合は解約可能です」"
    },
    
    # 「通知をもって効力発生」系（同意不要）
    "notice_only_effective": {
        "pattern": r"(通知|告知|掲示).{0,10}(をもって|により|した時点で).{0,10}(効力|有効|適用).{0,5}(が生じ|を生じ|が発生|となる)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "通知のみで効力発生。重要事項の変更には同意が必要な場合も",
        "check_points": [
            "変更内容の重要性を確認",
            "異議申立や解約の機会があるか",
            "定型約款の変更ルール（民法548条の4）を確認"
        ],
        "legal_basis": "民法548条の4",
        "rewrite": "「通知後○日間の異議申立期間を設け、異議がある場合は解約可能とします」"
    },
}


# =============================================================================
# 証明責任転換パターン
# =============================================================================

BURDEN_SHIFT_PATTERNS = {
    # 「証明しない限り」系
    "unless_proven": {
        "pattern": r"(ユーザー|利用者|乙|お客様).{0,10}(証明|立証|挙証).{0,10}(しない限り|できない限り|なき限り)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "証明責任を消費者に転嫁。本来事業者が負うべき証明責任の不当転嫁",
        "check_points": [
            "本来の証明責任の所在を確認",
            "消費者に過度な負担を課していないか",
            "消費者契約法10条で無効となり得る"
        ],
        "legal_basis": "消費者契約法10条、民事訴訟法の証明責任原則",
        "rewrite": "削除または「当社において○○を確認できた場合」に修正"
    },
    
    # 「当社の判断により」系
    "company_sole_discretion": {
        "pattern": r"(当社|甲|弊社).{0,5}(のみ|単独|独自).{0,5}(判断|裁量|決定).{0,10}(により|によって|で).{0,10}(できる|する|行う)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "事業者の一方的判断で重要事項を決定。恣意的運用のリスク",
        "check_points": [
            "判断対象が何か確認",
            "判断基準が明示されているか",
            "不服申立の機会があるか"
        ],
        "legal_basis": "民法1条2項（信義則）",
        "rewrite": "「合理的な基準に基づき判断し、その理由を通知します」"
    },
    
    # 「異議を述べることができない」系
    "no_objection_allowed": {
        "pattern": r"(異議|不服|クレーム).{0,15}(述べる|申し立てる|申立てる|主張する|行う).{0,10}(ことができない|ことはできない|ものとする|できません)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "異議申立権の剥奪。基本的権利の不当な制限",
        "check_points": [
            "異議申立権は基本的権利",
            "裁判を受ける権利の侵害にもなり得る",
            "消費者契約法10条で無効"
        ],
        "legal_basis": "憲法32条（裁判を受ける権利）、消費者契約法10条",
        "rewrite": "削除すべき条項"
    },
}


# =============================================================================
# 実質的解約困難パターン
# =============================================================================

DIFFICULT_CANCELLATION_PATTERNS = {
    # 長期の解約予告期間
    "long_cancellation_notice": {
        "pattern": r"(解約|解除|退会).{0,20}(書面|文書).{0,10}(による|での).{0,10}(申出|届出|通知).{0,10}から.{0,5}(\d+)\s*(日|ヶ月)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "長期の解約予告期間。実質的な解約困難を招く可能性",
        "check_points": [
            "予告期間の長さを確認",
            "30日超は消費者に不利な可能性",
            "書面要件が過度に厳格でないか"
        ],
        "legal_basis": "消費者契約法10条、特定商取引法",
        "validate": lambda m: int(m.group(5)) > 30 if "日" in m.group(6) else int(m.group(5)) > 1
    },
    
    # 解約時の高額違約金
    "high_cancellation_fee": {
        "pattern": r"(解約|中途解約|途中解約).{0,20}(違約金|解約金|キャンセル料).{0,10}として.{0,10}(\d+)\s*(万円|%|パーセント)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "解約時の高額な違約金。解約抑止効果が過度な可能性",
        "check_points": [
            "違約金の金額・割合を確認",
            "平均的損害を超えていないか（消費者契約法9条）",
            "解約の自由を不当に制限していないか"
        ],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # 解約手続きの過度な制限
    "restrictive_cancellation_method": {
        "pattern": r"(解約|解除|退会).{0,10}(電話|窓口|来店|対面).{0,10}(のみ|に限|でなければ|以外.{0,5}認め)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "解約方法の過度な制限。オンライン契約なのに電話・来店のみ等",
        "check_points": [
            "契約方法と解約方法の均衡",
            "オンライン契約はオンライン解約を認めるべき",
            "特商法の規制を確認"
        ],
        "legal_basis": "特定商取引法15条の3、消費者契約法10条",
        "rewrite": "「解約は、マイページまたは○○への連絡により行うことができます」"
    },
}


# =============================================================================
# 曖昧な重大事由パターン
# =============================================================================

VAGUE_SERIOUS_CAUSE_PATTERNS = {
    # 「重大な事由」未定義
    "undefined_serious_cause": {
        "pattern": r"(重大な|重要な|正当な).{0,5}(事由|理由|原因).{0,10}(ある|あった|認め).{0,10}(場合|ときは?).{0,10}(解除|解約|停止|終了).{0,10}(できる|する)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "「重大な事由」が定義されていない。恣意的な解除権行使のリスク",
        "check_points": [
            "「重大な事由」の具体的内容を確認",
            "例示列挙があるか確認",
            "判断基準が明確か確認"
        ],
        "legal_basis": "民法541条（解除の催告）",
        "rewrite": "「以下の事由がある場合は解除できる：①○○、②△△、③その他これに準ずる重大な事由」"
    },
    
    # 「信頼関係を損なう」系
    "trust_relationship_clause": {
        "pattern": r"(信頼関係|信用).{0,10}(損な|毀損|破壊).{0,10}(場合|行為|ときは?).{0,10}(解除|解約|停止)",
        "verdict": EdgeVerdict.REVIEW_MED,
        "risk_explanation": "「信頼関係」の毀損は主観的判断に依存。基準が不明確",
        "check_points": [
            "信頼関係毀損の具体例を確認",
            "客観的基準があるか確認",
            "催告・是正機会があるか確認"
        ],
        "legal_basis": "判例法理（信頼関係破壊の法理）"
    },
    
    # 「その他当社が不適切と判断」系
    "catch_all_inappropriate": {
        "pattern": r"(その他|上記.{0,5}ほか).{0,10}(当社|甲|弊社).{0,10}(不適切|不適当|問題).{0,10}(と判断|と認め)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "包括的な不適切条項。何でも不適切と判断できてしまう",
        "check_points": [
            "包括条項の範囲が広すぎないか",
            "具体的な例示があるか",
            "恣意的運用の防止策があるか"
        ],
        "legal_basis": "民法1条2項（信義則）"
    },
}


# =============================================================================
# 条件付き全面免責パターン（形式的除外）
# =============================================================================

CONDITIONAL_WAIVER_PATTERNS = {
    # 「〜の場合を除き」だが除外が形式的
    "formal_exception_only": {
        "pattern": r"(天災|不可抗力|システム障害).{0,10}(場合|による).{0,10}(除き?|以外).{0,20}(一切|いかなる).{0,10}(責任|賠償).{0,10}(負わない|しない)",
        "verdict": EdgeVerdict.NG,
        "risk_explanation": "除外事由が形式的で実質的に全面免責。天災以外でも免責される",
        "check_points": [
            "除外事由が実質的に意味があるか",
            "故意・重過失が除外されているか",
            "消費者契約法8条の強行規定に注意"
        ],
        "legal_basis": "消費者契約法8条",
        "rewrite": "「当社の故意または重過失による場合および法令で免責が禁止される場合を除き」"
    },
    
    # 「法令で認められる範囲で」免責
    "to_extent_permitted_by_law": {
        "pattern": r"(法令|法律).{0,10}(認められる|許容される|許される).{0,10}(範囲|限度).{0,10}(で|において).{0,10}(免責|責任を負わない|責任を排除)",
        "verdict": EdgeVerdict.REVIEW_MED,
        "risk_explanation": "法令で認められる最大限の免責を主張。内容が不明確",
        "check_points": [
            "具体的に何が免責されるのか不明確",
            "消費者が予測できない",
            "透明性の観点から問題"
        ],
        "legal_basis": "消費者契約法3条（情報提供義務）"
    },
}


# =============================================================================
# 公開判例パターン（CASE_LAW_PATTERNS）- FALSE_OK=0達成用
# =============================================================================

CASE_LAW_PATTERNS = {
    # -------------------------------------------------------------------------
    # 学費返還関連（消費者契約法9条1号、最判平成18年11月27日）
    # -------------------------------------------------------------------------
    "tuition_no_refund": {
        "pattern": r"(入学金|授業料|学費|納入金).{0,20}(一切|いかなる|理由.{0,5}問わず).{0,10}(返還|返金|返却).{0,10}(しない|しません|いたしません|できない|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "学費の一切不返還条項。最高裁判例（平成18年11月27日）で消費者契約法9条1号違反と判示",
        "check_points": ["消費者契約法9条1号（平均的損害超過）", "最判平成18年11月27日", "4月1日以前の辞退は返還必要"],
        "legal_basis": "消費者契約法9条1号"
    },
    "tuition_no_refund_simple": {
        "pattern": r"(入学金|授業料|学費|納入金).{0,30}(返還|返金|返却).{0,10}(しない|しません|いたしません|できない|に応じない|には応じ)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "学費不返還条項。時期により消費者契約法9条1号違反の可能性",
        "check_points": ["返還拒否の時期・条件を確認", "4月1日以降なら授業料は返還不要の判例あり", "入学金は返還不要との判例あり"],
        "legal_basis": "消費者契約法9条1号"
    },
    "tuition_forfeit_all": {
        "pattern": r"(入学|辞退|キャンセル).{0,20}(場合|した場合|しても|ても).{0,15}(全額|納入済|既納).{0,10}(返還|返金).{0,10}(しない|しません|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "入学辞退時の学費全額没収。最高裁判例で無効とされた条項類型",
        "check_points": ["消費者契約法9条1号", "辞退時期により返還義務の有無が異なる", "3月31日以前の辞退は授業料返還必要"],
        "legal_basis": "消費者契約法9条1号"
    },
    "early_withdrawal_no_refund": {
        "pattern": r"(3月|4月|入学前|入学式前).{0,20}(辞退|キャンセル|取消).{0,20}(返還|返金).{0,10}(しない|しません|できない|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "入学前辞退でも学費不返還。最高裁判例に反する",
        "check_points": ["3月31日以前の辞退は授業料返還が原則", "入学金は性質上返還不要とされる", "平均的損害を超える部分は無効"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # -------------------------------------------------------------------------
    # 敷金・原状回復関連（民法622条の2、国土交通省ガイドライン）
    # -------------------------------------------------------------------------
    "deposit_full_forfeit": {
        "pattern": r"(敷金|保証金|預り金).{0,15}(全額|一切|いかなる).{0,10}(償却|没収|返還.{0,5}しない|控除)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "敷金全額没収条項。民法622条の2、消費者契約法10条違反",
        "check_points": ["敷金は賃借人の債務を担保するもの", "原則返還が民法の定め", "全額償却特約は消費者契約法10条で無効の可能性大"],
        "legal_basis": "民法622条の2、消費者契約法10条"
    },
    "normal_wear_tenant_burden": {
        "pattern": r"(通常.{0,3}(損耗|使用|摩耗)|自然.{0,3}(損耗|劣化)|経年.{0,3}(劣化|変化)).{0,15}(借主|賃借人|乙|入居者).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "通常損耗を借主負担とする条項。国交省ガイドライン・判例に反する",
        "check_points": ["通常損耗は貸主負担が原則", "国土交通省原状回復ガイドライン", "消費者契約法10条で無効"],
        "legal_basis": "民法621条、消費者契約法10条"
    },
    "excessive_restoration": {
        "pattern": r"(原状回復|クリーニング).{0,15}(全額|すべて|一切).{0,10}(借主|賃借人|乙|入居者).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "原状回復費用全額借主負担。通常損耗分まで負担させる違法条項",
        "check_points": ["原状回復は借主の故意・過失部分のみ", "通常損耗・経年劣化は貸主負担", "国交省ガイドライン参照"],
        "legal_basis": "民法621条、消費者契約法10条"
    },
    "unconditional_replacement": {
        "pattern": r"(壁紙|クロス|畳|フローリング|カーペット).{0,15}(全面|全部|すべて).{0,10}(張替|交換|取替).{0,10}(借主|賃借人|乙).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "内装全面張替え借主負担。経年劣化分まで負担させる違法条項",
        "check_points": ["壁紙等は経年劣化で価値減少", "残存価値のみが借主負担範囲", "6年で残存価値1円との判例あり"],
        "legal_basis": "民法621条、消費者契約法10条"
    },
    "excessive_cleaning_fee": {
        "pattern": r"(クリーニング|清掃|ハウスクリーニング).{0,10}(費用|代|料金).{0,10}(として|を).{0,10}(\d+).{0,5}(万円|円)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "定額クリーニング費用。金額が過大な場合は消費者契約法9条1号違反",
        "check_points": ["金額の妥当性を確認", "相場を大きく超える場合は問題", "消費者契約法9条1号（平均的損害）"],
        "legal_basis": "消費者契約法9条1号"
    },
    "deposit_excess_no_return": {
        "pattern": r"(敷金|保証金).{0,20}(超過|超える|上回).{0,15}(返還|返金|返却).{0,10}(しない|しません|できない|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "敷金から債務を差し引いた残額を返還しない条項。民法622条の2違反",
        "check_points": ["敷金は債務控除後の残額返還が義務", "民法622条の2", "消費者契約法10条で無効"],
        "legal_basis": "民法622条の2、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # 解約料・キャンセル料関連（消費者契約法9条1号）
    # -------------------------------------------------------------------------
    "excessive_cancellation_fee": {
        "pattern": r"(解約|キャンセル|取消|中途解約).{0,15}(料|金|費用|違約金).{0,10}(として|は).{0,10}(代金|料金|費用|金額).{0,5}(の|).{0,5}(\d{2,3})\s*(%|パーセント|％)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "高率の解約料・キャンセル料。消費者契約法9条1号（平均的損害）超過の疑い",
        "check_points": ["解約料は平均的損害の範囲内が原則", "50%超は過大の可能性大", "時期に応じた段階的料率が望ましい"],
        "legal_basis": "消費者契約法9条1号"
    },
    "high_percentage_cancellation": {
        "pattern": r"(解約|キャンセル|取消).{0,20}(場合|した場合|のとき).{0,15}(\d{2,3})\s*(%|パーセント|％).{0,10}(違約金|キャンセル料|解約料|を申し受け)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "高率のキャンセル料を定める条項。平均的損害超過で無効の可能性",
        "check_points": ["30%超の解約料は要検討", "実損害との乖離を確認", "消費者契約法9条1号"],
        "legal_basis": "消費者契約法9条1号"
    },
    "prepaid_no_refund": {
        "pattern": r"(前払|先払|前納|既払|支払済).{0,15}(料金|代金|費用|金額).{0,15}(返還|返金|返却).{0,10}(しない|しません|できない|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "前払金の一切不返還条項。サービス未提供分は返還が原則",
        "check_points": ["役務未提供分は返還義務あり", "消費者契約法9条1号", "特定商取引法の中途解約規定"],
        "legal_basis": "消費者契約法9条1号、特定商取引法49条"
    },
    "flat_high_cancellation_fee": {
        "pattern": r"(解約|キャンセル|取消).{0,15}(場合|理由.{0,5}問わず).{0,15}(\d+)\s*(万円|円).{0,10}(違約金|キャンセル料|解約料|を申し受け|をお支払い)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "定額の解約料・キャンセル料。金額が過大な場合は消費者契約法9条1号違反",
        "check_points": ["金額の妥当性を確認", "契約金額との比率を確認", "平均的損害との乖離を確認"],
        "legal_basis": "消費者契約法9条1号"
    },
    "no_refund_any_case": {
        "pattern": r"(いかなる|一切|理由.{0,5}問わず|どのような).{0,10}(場合|理由|事情).{0,10}(も|でも|であっても).{0,10}(返金|返還|払い戻し).{0,10}(しない|しません|できない|に応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "理由を問わない返金拒否条項。消費者契約法9条・10条違反",
        "check_points": ["未提供サービス分は返還義務", "消費者契約法9条1号", "消費者契約法10条"],
        "legal_basis": "消費者契約法9条1号、10条"
    },
    
    # -------------------------------------------------------------------------
    # サルベージ条項（消費者契約法8条の3）
    # -------------------------------------------------------------------------
    "salvage_clause": {
        "pattern": r"(法令|法律).{0,10}(で|により|上).{0,10}(認められる|許される|許容される|有効とされる).{0,10}(限り|範囲|限度).{0,10}(で|において).{0,10}(責任|賠償|免責)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "サルベージ条項。消費者契約法8条の3で無効とされる条項類型",
        "check_points": ["消費者契約法8条の3（サルベージ条項の無効）", "2022年改正で明文化", "免責範囲の不明確さが問題"],
        "legal_basis": "消費者契約法8条の3"
    },
    "salvage_clause_v2": {
        "pattern": r"(強行法規|強行規定|法令).{0,10}(に反しない|違反しない|許容される).{0,10}(限り|範囲).{0,10}(免責|責任を負わない|責任を排除)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "サルベージ条項の変形。法令で認められる最大限の免責を主張",
        "check_points": ["消費者契約法8条の3", "免責範囲が不明確", "消費者に不当な不利益"],
        "legal_basis": "消費者契約法8条の3"
    },
}

# =============================================================================
# 労働関連追加パターン（LABOR_EXTENDED_PATTERNS）
# =============================================================================

LABOR_EXTENDED_PATTERNS = {
    # 退職制限
    "excessive_notice_period": {
        "pattern": r"(退職|辞職|離職).{0,20}(\d+)\s*(ヶ月|か月|カ月|箇月).{0,10}(前|以前).{0,10}(届出|届け出|通知|申出|申し出)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "過度に長い退職予告期間。民法627条（2週間）を大幅に超過",
        "check_points": ["民法627条は2週間前の申入れで退職可能", "就業規則で1ヶ月程度は許容されうる", "3ヶ月以上は過度な制限"],
        "legal_basis": "民法627条、労働基準法",
        "validate": lambda m: int(m.group(2)) >= 3
    },
    "training_cost_return": {
        "pattern": r"(研修|教育|訓練|留学).{0,10}(費用|経費|費).{0,15}(返還|返済|賠償|負担).{0,10}(する|しなければ|義務)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "研修費用の返還条項。労働基準法16条（賠償予定の禁止）違反の可能性",
        "check_points": ["労働基準法16条違反の可能性", "業務と無関係な自己啓発費用は除く", "強制的な研修の費用負担は違法"],
        "legal_basis": "労働基準法16条"
    },
    "fixed_overtime_unclear": {
        "pattern": r"(固定残業|みなし残業|定額残業).{0,20}(含む|含まれ|として).{0,10}(支給|支払)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "固定残業代の定め。時間数・金額が不明確な場合は違法",
        "check_points": ["固定残業の対象時間数を確認", "超過分の追加支給の有無を確認", "基本給と固定残業代の区分を確認"],
        "legal_basis": "労働基準法37条"
    },
    "no_overtime_pay": {
        "pattern": r"(残業|時間外|休日出勤).{0,10}(手当|代|割増).{0,10}(支給しない|支払わない|なし|含む)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "残業代不支給条項。労働基準法37条違反",
        "check_points": ["労働基準法37条（割増賃金）強行規定", "管理監督者でも深夜割増は必要", "固定残業制でも超過分は支給必要"],
        "legal_basis": "労働基準法37条"
    },
    "excessive_wage_deduction": {
        "pattern": r"(遅刻|欠勤|早退).{0,15}(控除|減額|カット).{0,10}(として|を).{0,10}(\d+)\s*(倍|%|日分)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "過大な賃金控除。ノーワークノーペイの原則を超えた減給は違法",
        "check_points": ["労働基準法91条（制裁規定の制限）", "1事案で平均賃金1日分の半額まで", "総額で月給の10分の1まで"],
        "legal_basis": "労働基準法91条"
    },
    "unilateral_wage_cut": {
        "pattern": r"(会社|当社|使用者|甲).{0,10}(判断|都合|必要).{0,10}(により|で|に応じ).{0,10}(賃金|給与|報酬).{0,10}(減額|引下げ|変更)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的賃金引下げ条項。労働条件の不利益変更は原則合意が必要",
        "check_points": ["労働契約法8条（合意原則）", "就業規則変更による不利益変更は厳格要件", "労働条件の一方的引下げは無効"],
        "legal_basis": "労働契約法8条、9条"
    },
    "no_resignation_v2": {
        "pattern": r"(会社|当社|使用者).{0,10}(承認|許可|同意).{0,10}(なく|なければ|得ずに).{0,10}(退職|辞職).{0,10}(できない|認めない|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "退職に会社承認を要求。退職の自由を侵害",
        "check_points": ["退職は労働者の権利", "会社の承認は不要（民法627条）", "強制労働の禁止（労基法5条）"],
        "legal_basis": "民法627条、労働基準法5条"
    },
    "long_notice_period": {
        "pattern": r"(退職|辞職).{0,10}(希望|意思).{0,15}(\d+)\s*(日|週間).{0,10}(前|以前).{0,10}(届出|通知|申出)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "長い退職予告期間。30日を超える場合は過度な可能性",
        "check_points": ["民法627条は2週間", "就業規則で30日程度は許容", "60日以上は過度な制限の可能性"],
        "legal_basis": "民法627条",
        "validate": lambda m: int(m.group(3)) > 30 if "日" in m.group(4) else int(m.group(3)) > 4
    },
    
    # 競業避止
    "indefinite_non_compete": {
        "pattern": r"(競業|競合|同業).{0,10}(禁止|避止|制限).{0,15}(期間|定め).{0,10}(なし|なく|制限なし|無期限)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "無期限の競業避止義務。職業選択の自由を過度に制限",
        "check_points": ["競業避止は期間・地域・職種を限定すべき", "無期限は公序良俗違反", "憲法22条（職業選択の自由）"],
        "legal_basis": "憲法22条、民法90条"
    },
    "non_compete_no_compensation": {
        "pattern": r"(競業|競合|同業).{0,10}(禁止|避止|制限).{0,20}(代償|補償|対価).{0,10}(なし|なく|支払わない|伴わない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "代償措置なしの競業避止。判例上無効となる可能性大",
        "check_points": ["代償措置は競業避止有効性の重要要素", "代償なしは無効判断の傾向", "在職中の高待遇は代償として不十分な場合も"],
        "legal_basis": "判例法理、憲法22条"
    },
    "any_competitor_ban": {
        "pattern": r"(退職後|離職後|雇用終了後).{0,15}(一切|いかなる|すべて).{0,10}(競合|同業|競業).{0,10}(企業|会社|事業).{0,10}(就職|転職|勤務|従事).{0,10}(禁止|できない|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "退職後の全面的競業禁止。職業選択の自由を侵害",
        "check_points": ["対象企業・業種・地域の限定が必要", "全面禁止は無効", "憲法22条"],
        "legal_basis": "憲法22条、判例法理"
    },
    "transfer_ban_no_comp": {
        "pattern": r"(転籍|出向|異動).{0,15}(拒否|拒む).{0,10}(できない|ものとする|しない)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "転籍・出向拒否禁止条項。本人同意が必要な場合も",
        "check_points": ["転籍は原則として本人同意が必要", "出向は就業規則の根拠と合理性が必要", "一方的な異動命令は無効の可能性"],
        "legal_basis": "労働契約法14条"
    },
    "overtime_in_base_no_extra": {
        "pattern": r"(基本給|月給|給与).{0,10}(に|には).{0,10}(\d+).{0,5}(時間|h).{0,10}(残業|時間外).{0,10}(含む|含まれ|として)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "基本給に残業代を含む定め。明確区分と超過分支給の確認が必要",
        "check_points": ["基本給と残業代の明確区分が必要", "対象時間を超えた分は追加支給必要", "固定残業制の適法要件を確認"],
        "legal_basis": "労働基準法37条"
    },
}

# =============================================================================
# 偽装請負追加パターン（DISGUISED_EMPLOYMENT_PATTERNS）
# =============================================================================

DISGUISED_EMPLOYMENT_PATTERNS = {
    "work_location_control": {
        "pattern": r"(委託者|発注者|甲).{0,10}(指定|指示).{0,10}(する|した).{0,10}(場所|事業所|事務所).{0,10}(で|において|にて).{0,10}(業務|作業|勤務)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "業務委託なのに勤務場所を指定。偽装請負の典型的指標",
        "check_points": ["業務委託は場所・時間の拘束がないのが原則", "職業安定法44条違反", "労働者派遣法違反"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    "direct_supervision": {
        "pattern": r"(委託者|発注者|甲).{0,10}(従業員|担当者|社員).{0,10}(の|が).{0,10}(指示|指導|監督).{0,10}(に従|のもと|を受け)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注者従業員からの直接指揮。偽装請負の典型",
        "check_points": ["請負は仕事の完成が目的", "発注者からの直接指揮は雇用関係の徴表", "労働者派遣法違反"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    "personnel_approval": {
        "pattern": r"(委託者|発注者|甲).{0,10}(承認|承諾|同意).{0,10}(なく|なしに|を得ず).{0,10}(担当者|人員|スタッフ).{0,10}(変更|交代).{0,10}(できない|禁止|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注者が担当者を事実上支配。偽装請負の指標",
        "check_points": ["請負は受注者が人員配置を決定", "発注者の人事関与は偽装請負", "職業安定法44条違反"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    "work_time_control": {
        "pattern": r"(委託者|発注者|甲).{0,10}(定める|指定|指示).{0,10}(勤務時間|就業時間|稼働時間|作業時間).{0,10}(に従|で|において)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注者が勤務時間を支配。偽装請負の典型的指標",
        "check_points": ["業務委託は時間拘束がないのが原則", "出退勤管理は雇用の徴表", "職業安定法44条違反"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    "exclusive_engagement": {
        "pattern": r"(受託者|乙).{0,10}(他|他社|第三者).{0,10}(業務|仕事|契約).{0,10}(受託|受注|従事).{0,10}(禁止|できない|してはならない)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "専属契約条項。過度な場合は偽装請負・独禁法違反の可能性",
        "check_points": ["業務委託は本来独立した事業者", "専属要求は従属性の指標", "独占禁止法（優越的地位の濫用）"],
        "legal_basis": "職業安定法44条、独占禁止法"
    },
}

# =============================================================================
# 下請法関連パターン（SUBCONTRACT_ACT_PATTERNS）
# =============================================================================

SUBCONTRACT_ACT_PATTERNS = {
    "payment_over_60days": {
        "pattern": r"(代金|報酬|委託料).{0,10}(支払|払い).{0,10}(は|を).{0,10}(検収|納品|受領).{0,10}(完了|後).{0,10}から.{0,5}(\d+)\s*(日|営業日)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "60日超の支払期限。下請法2条の2違反",
        "check_points": ["下請法は受領日から60日以内の支払義務", "60日超は下請法違反", "3条書面の記載事項"],
        "legal_basis": "下請法2条の2",
        "validate": lambda m: int(m.group(6)) > 60
    },
    "payment_120day_site": {
        "pattern": r"(支払|払い).{0,15}(\d+)\s*(日|営業日).{0,10}(以内|後|サイト)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "60日超の支払条件。下請法違反の疑い",
        "check_points": ["下請法は60日以内", "120日サイトは明確な違反", "公正取引委員会への相談"],
        "legal_basis": "下請法2条の2",
        "validate": lambda m: int(m.group(2)) > 60
    },
    "payment_next_next_month": {
        "pattern": r"(報酬|代金|支払).{0,10}(は|を).{0,10}(納品|検収).{0,5}(月|日).{0,5}(の|).{0,5}(翌々月|翌翌月|2ヶ月後|2か月後)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "翌々月払いの支払条件。下請法2条の2違反の可能性大",
        "check_points": ["受領日から60日以内が原則", "翌々月末は60日超の可能性大", "下請法違反"],
        "legal_basis": "下請法2条の2"
    },
    "unilateral_order_cancel": {
        "pattern": r"(発注者|委託者|甲|当社).{0,10}(都合|判断|理由).{0,10}(により|で).{0,10}(いつでも|自由に|一方的に).{0,10}(発注|注文|委託).{0,10}(取消|キャンセル|解除)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的な発注取消条項。下請法4条1項1号違反",
        "check_points": ["下請法4条1項1号（受領拒否の禁止）", "正当な理由のない取消は違法", "損害賠償義務"],
        "legal_basis": "下請法4条1項1号"
    },
    "price_reduction_after_order": {
        "pattern": r"(発注後|注文後|契約後).{0,10}(であっても|でも|においても).{0,10}(単価|価格|代金).{0,10}(引下げ|値下げ|減額|変更)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注後の単価引下げ条項。下請法4条1項5号違反",
        "check_points": ["下請法4条1項5号（買いたたきの禁止）", "発注後の一方的減額は違法", "下請事業者の同意があっても問題"],
        "legal_basis": "下請法4条1項5号"
    },
    "improper_return": {
        "pattern": r"(納品|成果物).{0,15}(当社|甲|発注者).{0,10}(基準|判断|都合).{0,10}(に合わない|を満たさない|不適合).{0,10}(場合|ときは).{0,10}(返品|返却|やり直し)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "不当返品条項。下請法4条1項4号違反の疑い",
        "check_points": ["下請法4条1項4号（返品の禁止）", "受領後の一方的返品は原則違法", "瑕疵がある場合を除く"],
        "legal_basis": "下請法4条1項4号"
    },
    "order_cancel_no_comp": {
        "pattern": r"(発注|注文|委託).{0,10}(取消|キャンセル|解除).{0,10}(した場合|の場合).{0,10}(補償|賠償|費用負担).{0,10}(しない|しません|なし|行わない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注取消時の補償なし条項。下請法4条2項4号違反",
        "check_points": ["下請法4条2項4号（不当なやり直しの禁止）", "取消による損害は賠償必要", "既に発生した費用の負担"],
        "legal_basis": "下請法4条2項4号"
    },
    "price_squeeze": {
        "pattern": r"(通常|市場|相場).{0,10}(価格|単価).{0,10}(より|に比べ|と比較して).{0,10}(著しく|大幅に).{0,10}(低い|安い|下回る)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "著しく低い価格での取引。下請法4条1項5号違反の疑い",
        "check_points": ["下請法4条1項5号（買いたたきの禁止）", "正当な理由のない著しい低価格は違法", "原価を下回る単価は問題"],
        "legal_basis": "下請法4条1項5号"
    },
    "return_unconditional_accept": {
        "pattern": r"(受託者|乙|下請事業者).{0,10}(返品|やり直し|再納品).{0,10}(に|には|を).{0,10}(無条件|理由.{0,5}問わず|いかなる場合も).{0,10}(応じ|受け入れ|対応)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "無条件返品受入条項。下請法4条1項4号違反",
        "check_points": ["正当な理由のない返品は違法", "瑕疵がない限り返品拒否可能", "下請法4条1項4号"],
        "legal_basis": "下請法4条1項4号"
    },
    "economic_benefit_request": {
        "pattern": r"(金銭|協賛金|負担金|寄付).{0,10}(提供|支払|拠出).{0,10}(を|の).{0,10}(求め|要求|要請)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "経済上の利益提供要請。下請法4条2項3号違反の疑い",
        "check_points": ["下請法4条2項3号（不当な経済上の利益提供要請の禁止）", "正当な理由のない金銭要求は違法", "協賛金等の強制は問題"],
        "legal_basis": "下請法4条2項3号"
    },
    "retaliation_clause": {
        "pattern": r"(公正取引委員会|中小企業庁|行政機関).{0,10}(届出|通報|相談|申告).{0,10}(した場合|したとき).{0,10}(取引|契約).{0,10}(停止|解除|終了|中止)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "報復条項。下請法4条1項7号違反",
        "check_points": ["下請法4条1項7号（報復措置の禁止）", "通報を理由とする不利益取扱いは違法", "公益通報者保護法も適用"],
        "legal_basis": "下請法4条1項7号"
    },
}

# =============================================================================
# 不動産追加パターン（REAL_ESTATE_EXTENDED_PATTERNS）
# =============================================================================

REAL_ESTATE_EXTENDED_PATTERNS = {
    "high_renewal_fee": {
        "pattern": r"(更新料|更新手数料).{0,10}(として|は|を).{0,10}(賃料|家賃).{0,5}(の|).{0,5}(\d+)\s*(ヶ月|か月|カ月|倍)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "高額な更新料。賃料2ヶ月分超は過大の可能性",
        "check_points": ["更新料は1～2ヶ月分が相場", "3ヶ月以上は過大", "消費者契約法10条で無効の可能性"],
        "legal_basis": "消費者契約法10条",
        "validate": lambda m: int(m.group(5)) >= 2
    },
    "unilateral_renewal_reject": {
        "pattern": r"(貸主|甲|家主|オーナー).{0,10}(理由.{0,5}問わず|自由に|いつでも|都合により).{0,10}(契約.{0,5}更新|更新).{0,10}(拒否|拒絶|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "貸主の一方的更新拒否条項。借地借家法28条違反",
        "check_points": ["借地借家法28条（正当事由要件）", "更新拒絶には正当事由が必要", "借主保護の強行規定"],
        "legal_basis": "借地借家法28条"
    },
    "fixed_term_without_explanation": {
        "pattern": r"(定期借家|定期建物賃貸借).{0,15}(契約|として).{0,15}(更新|更新がない|更新なし)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "定期借家契約。書面による事前説明義務の確認が必要",
        "check_points": ["借地借家法38条（定期借家の要件）", "事前に書面交付・説明が必要", "説明なければ普通借家契約となる"],
        "legal_basis": "借地借家法38条"
    },
    "replacement_tenant_burden": {
        "pattern": r"(設備|備品|器具|機器).{0,10}(故障|破損|不具合).{0,10}(に関わらず|問わず|原因.{0,5}問わず).{0,10}(借主|賃借人|乙).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "設備故障を原因問わず借主負担とする条項。経年劣化は貸主負担が原則",
        "check_points": ["設備の経年劣化は貸主負担", "借主の故意・過失による場合のみ借主負担", "民法606条（修繕義務）"],
        "legal_basis": "民法606条、消費者契約法10条"
    },
    "unconditional_tenant_replacement": {
        "pattern": r"(借主|賃借人|乙).{0,10}(負担|費用).{0,10}(で|において|にて).{0,10}(すべて|全部|一切).{0,10}(の|).{0,5}(修繕|補修|交換)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "全修繕費用借主負担条項。小修繕を超える部分は貸主負担が原則",
        "check_points": ["大修繕は貸主負担が原則", "民法606条", "特約があっても消費者契約法10条で無効の可能性"],
        "legal_basis": "民法606条、消費者契約法10条"
    },
    "no_renewal_termination": {
        "pattern": r"(契約期間|期間).{0,10}(満了|終了).{0,10}(をもって|により|した場合).{0,10}(当然|自動的).{0,10}(終了|解約|明渡し)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "期間満了による当然終了条項。普通借家では更新拒絶に正当事由が必要",
        "check_points": ["普通借家は法定更新あり", "定期借家でなければ当然終了とならない", "借地借家法26条・28条"],
        "legal_basis": "借地借家法26条、28条"
    },
    "hand_money_over_20pct": {
        "pattern": r"(手付金|手付).{0,10}(として|を).{0,10}(売買.{0,5}代金|代金).{0,5}(の|).{0,5}(\d+)\s*(%|パーセント|％)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "手付金20%超の条項。宅建業法39条違反",
        "check_points": ["宅建業法39条（手付金の額の制限）", "売買代金の20%を超えてはならない", "超過部分は手付とみなされない"],
        "legal_basis": "宅建業法39条",
        "validate": lambda m: int(m.group(5)) > 20
    },
}

# =============================================================================
# フランチャイズ関連パターン（FRANCHISE_PATTERNS）
# =============================================================================

FRANCHISE_PATTERNS = {
    "fc_no_termination": {
        "pattern": r"(加盟店|フランチャイジー|乙).{0,10}(は|が).{0,10}(いかなる|一切|どのような).{0,10}(理由|事由|場合).{0,10}(中途解約|契約解除|解約).{0,10}(できない|認めない|禁止)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "中途解約禁止条項。契約の拘束力として過度",
        "check_points": ["中小小売商業振興法11条", "過度な解約制限は公序良俗違反", "やむを得ない事由による解約は認められるべき"],
        "legal_basis": "中小小売商業振興法11条、民法90条"
    },
    "fc_territory_violation": {
        "pattern": r"(本部|フランチャイザー|甲).{0,10}(は|が).{0,10}(テリトリー|商圏|営業区域).{0,10}(内|において).{0,10}(いつでも|自由に|制限なく).{0,10}(出店|開店|店舗)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "テリトリー保証違反条項。本部の一方的な商圏侵害を許容",
        "check_points": ["テリトリー保証は加盟店の重要な権利", "一方的な侵害は債務不履行", "独禁法違反の可能性も"],
        "legal_basis": "独占禁止法、民法415条"
    },
    "fc_supplier_restriction": {
        "pattern": r"(仕入|仕入れ|購入|調達).{0,10}(は|を).{0,10}(本部|甲|指定).{0,10}(業者|先|ルート).{0,10}(のみ|からのみ|に限|以外.{0,5}認め)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "仕入先指定条項。過度な場合は独禁法違反の可能性",
        "check_points": ["独占禁止法（拘束条件付取引）", "正当な理由のない仕入先強制は問題", "価格差がある場合は特に注意"],
        "legal_basis": "独占禁止法（拘束条件付取引）"
    },
    "fc_full_penalty": {
        "pattern": r"(中途解約|契約解除|解約).{0,10}(の場合|した場合|のとき).{0,10}(残存期間|残り期間).{0,10}(分|全額|全て).{0,10}(ロイヤリティ|ロイヤルティ|加盟金).{0,10}(違約金|として|支払)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "残存期間全額のロイヤリティを違約金とする条項。平均的損害を大幅超過",
        "check_points": ["消費者契約法9条1号類推", "平均的損害を超える部分は無効", "残存期間全額は過大"],
        "legal_basis": "消費者契約法9条1号類推、民法90条"
    },
    "fc_territory_accept": {
        "pattern": r"(加盟店|フランチャイジー|乙).{0,10}(は|が).{0,10}(本部|甲).{0,10}(による|の).{0,10}(テリトリー|商圏).{0,10}(内|への).{0,10}(出店|新店舗).{0,10}(異議|反対).{0,10}(述べ|申し立て).{0,10}(ない|ません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "本部出店への異議禁止条項。加盟店の権利を不当に制限",
        "check_points": ["テリトリー侵害に対する異議は正当な権利", "一方的な権利剥奪は問題", "独禁法違反の可能性"],
        "legal_basis": "独占禁止法、民法90条"
    },
    "designated_supplier_must": {
        "pattern": r"(すべて|全部|一切).{0,10}(の|).{0,5}(商品|材料|原材料|食材).{0,10}(本部|甲|指定).{0,10}(から|より|を通じ).{0,10}(仕入|購入|調達).{0,10}(しなければ|なければ|ものとする)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "全商品の本部仕入強制条項。独禁法違反の可能性大",
        "check_points": ["独占禁止法（拘束条件付取引）", "合理的理由のない全面強制は問題", "品質管理目的でも過度は違法"],
        "legal_basis": "独占禁止法"
    },
    "territory_store_consent": {
        "pattern": r"(本部|甲).{0,10}(新規|追加).{0,10}(出店|店舗).{0,10}(につき|について|に関し).{0,10}(加盟店|乙).{0,10}(同意|承諾).{0,10}(不要|なし|求めない)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "テリトリー内出店に同意不要とする条項。加盟店保護の観点から問題",
        "check_points": ["テリトリー保証の実効性", "本部の一方的出店は商圏侵害", "事前協議条項の検討"],
        "legal_basis": "中小小売商業振興法、独占禁止法"
    },
}

# =============================================================================
# IT・SaaS追加パターン（IT_SAAS_EXTENDED_PATTERNS）
# =============================================================================

IT_SAAS_EXTENDED_PATTERNS = {
    "service_stop_no_notice": {
        "pattern": r"(当社|甲|サービス提供者).{0,10}(は|が).{0,10}(事前.{0,5}通知|予告).{0,10}(なく|なしに|することなく).{0,10}(サービス|本サービス).{0,10}(停止|中止|終了|変更)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "事前通知なしのサービス停止条項。契約の本旨に反する一方的条項",
        "check_points": ["消費者契約法10条", "債務不履行責任", "一定期間の猶予が必要"],
        "legal_basis": "消費者契約法10条、民法415条"
    },
    "broad_ip_assignment": {
        "pattern": r"(ユーザー|利用者|お客様).{0,10}(作成|投稿|アップロード).{0,10}(した|する).{0,10}(コンテンツ|データ|著作物).{0,10}(著作権|知的財産権|権利).{0,10}(当社|甲|サービス提供者).{0,10}(に帰属|に移転|に譲渡)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "ユーザーコンテンツの著作権全面譲渡条項。著作権法の原則に反する",
        "check_points": ["著作権はクリエイターに帰属が原則", "全面譲渡は過度な条項", "利用許諾で足りる場合が多い"],
        "legal_basis": "著作権法、消費者契約法10条"
    },
    "unilateral_fee_increase": {
        "pattern": r"(当社|甲|サービス提供者).{0,10}(は|が).{0,10}(いつでも|事前.{0,5}通知.{0,5}なく|自由に|予告なく).{0,10}(利用料|料金|費用|価格).{0,10}(変更|改定|値上げ|増額)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的料金変更条項。消費者契約法10条違反",
        "check_points": ["料金変更には事前通知が必要", "消費者契約法10条", "異議申立・解約の機会が必要"],
        "legal_basis": "消費者契約法10条、民法548条の4"
    },
    "data_deletion_no_notice": {
        "pattern": r"(サービス|契約).{0,10}(終了|解約|停止).{0,10}(後|した場合).{0,10}(ユーザー|利用者|お客様).{0,10}(データ|情報).{0,10}(直ちに|速やかに|即座に|すべて).{0,10}(削除|消去|抹消)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "サービス終了後の即時データ削除条項。データ取得の猶予が必要",
        "check_points": ["ユーザーのデータ取得機会の確保", "一定期間のデータ保持が望ましい", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    "no_sla_guarantee": {
        "pattern": r"(当社|甲|サービス提供者).{0,10}(稼働率|可用性|サービスレベル|SLA).{0,10}(一切|いかなる).{0,10}(保証|担保).{0,10}(しない|しません|なし)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "SLA保証なし条項。B2Bサービスでは特に問題",
        "check_points": ["サービスの本質的機能の保証がない", "債務不履行責任との関係", "合理的なSLAの設定が望ましい"],
        "legal_basis": "民法415条（債務不履行）"
    },
    "unilateral_additional_cost": {
        "pattern": r"(当社|甲|サービス提供者).{0,10}(判断|都合|必要).{0,10}(により|で).{0,10}(追加.{0,5}費用|追加.{0,5}料金|別途.{0,5}費用).{0,10}(請求|徴収|負担)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的追加費用請求条項。消費者契約法10条違反",
        "check_points": ["追加費用は事前明示が原則", "一方的な請求は問題", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    "additional_cost_full_burden": {
        "pattern": r"(追加.{0,5}費用|追加.{0,5}料金|別途.{0,5}費用).{0,10}(すべて|全額|一切).{0,10}(ユーザー|利用者|お客様|乙).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "追加費用全額ユーザー負担条項。範囲・上限の明示が必要",
        "check_points": ["追加費用の範囲を確認", "上限の設定が望ましい", "事前通知の有無を確認"],
        "legal_basis": "消費者契約法10条"
    },
}

# =============================================================================
# FALSE_OK解消用 追加パターン
# =============================================================================

ADDITIONAL_PATTERNS_FOR_FALSE_OK = {
    # 壁紙全面張替え
    "wallpaper_full_replacement": {
        "pattern": r"(壁紙|クロス).{0,10}(全面|全部).{0,5}(張り替え|張替え|張替).{0,15}(借主|賃借人|乙).{0,10}(負担|費用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "壁紙全面張替え借主負担条項。通常損耗・経年劣化分まで借主負担は違法",
        "check_points": ["国交省ガイドライン違反", "経年劣化分は貸主負担が原則", "消費者契約法10条で無効"],
        "legal_basis": "民法621条、消費者契約法10条"
    },
    # 敷金差額返金なし
    "deposit_no_refund_diff": {
        "pattern": r"(敷金|保証金).{0,10}(下回|超えた|差額).{0,15}(返金|返還).{0,10}(しない|しません|なし)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "敷金残額不返還条項。債務控除後の残額は返還義務あり",
        "check_points": ["民法622条の2違反", "敷金は担保であり残額返還が原則", "消費者契約法10条で無効"],
        "legal_basis": "民法622条の2、消費者契約法10条"
    },
    # 解約料50%
    "cancellation_50pct": {
        "pattern": r"(解約|解除|キャンセル).{0,15}(理由.{0,5}問わず|いかなる).{0,10}(契約金額|代金|料金).{0,5}(の|).{0,5}50\s*(%|パーセント|％)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "解約料50%条項。平均的損害を大幅に超過する可能性大",
        "check_points": ["消費者契約法9条1号", "平均的損害の立証責任は事業者", "50%は過大な可能性大"],
        "legal_basis": "消費者契約法9条1号"
    },
    # キャンセル料全額
    "cancel_fee_full": {
        "pattern": r"(キャンセル|予約.{0,3}取消).{0,10}(いかなる|どのような).{0,10}(場合|理由).{0,10}(全額|100).{0,10}(キャンセル料|発生)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "いかなる場合も全額キャンセル料。消費者契約法9条1号違反",
        "check_points": ["消費者契約法9条1号", "時期に応じた段階料金が望ましい", "全額は過大"],
        "legal_basis": "消費者契約法9条1号"
    },
    # 退職承諾なし
    "resignation_no_approval": {
        "pattern": r"(会社|当社|使用者).{0,10}(承諾|承認|許可).{0,10}(なく|なければ).{0,10}(退職届|退職).{0,10}(提出|する).{0,10}(しても|ても|も).{0,10}(退職|辞める).{0,10}(できない|できません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "会社承諾なしの退職禁止条項。民法627条違反、労基法5条違反",
        "check_points": ["退職は労働者の権利（民法627条）", "会社の承諾は不要", "強制労働の禁止（労基法5条）"],
        "legal_basis": "民法627条、労働基準法5条"
    },
    # 競業避止5年
    "non_compete_5years": {
        "pattern": r"(退職後|離職後).{0,5}5\s*(年|年間).{0,10}(同業|競合|競業).{0,10}(就労|勤務|転職|従事).{0,10}(禁止|してはならない|できない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "5年間の競業避止義務。判例上、1-2年が上限とされる",
        "check_points": ["判例は1-2年を上限とする傾向", "5年は過度な制限", "公序良俗違反で無効"],
        "legal_basis": "民法90条、憲法22条"
    },
    # 競業避止代償なし
    "non_compete_no_comp_v2": {
        "pattern": r"(競合|同業|競業).{0,10}(転職|勤務|就労).{0,10}(禁止|制限).{0,15}(代償|補償|対価).{0,5}(措置|金).{0,5}(ありません|なし|はない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "代償措置なしの競業避止義務。判例上無効となる可能性大",
        "check_points": ["代償措置は有効性判断の重要要素", "代償なしは無効の傾向", "在職中の待遇だけでは不十分な場合も"],
        "legal_basis": "判例法理、憲法22条"
    },
    # 全同業種禁止
    "all_competitors_ban": {
        "pattern": r"(退職後|離職後).{0,10}(いかなる|一切|すべて).{0,5}(の|).{0,5}(同業種|同業|競合).{0,10}(会社|企業).{0,10}(勤務|就労|従事).{0,10}(できない|禁止)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "全同業種への就労禁止。職業選択の自由を過度に制限",
        "check_points": ["対象の限定がない全面禁止は無効", "憲法22条（職業選択の自由）", "地域・期間・業種の合理的限定が必要"],
        "legal_basis": "憲法22条、民法90条"
    },
    # 偽装請負：担当者指示
    "fake_contract_instruction": {
        "pattern": r"(業務.{0,3}受託者|受託者|乙).{0,10}(当社|甲|委託者).{0,5}(担当者|社員|従業員).{0,5}(の|).{0,5}(指示|指導|監督).{0,10}(に従|のもとで|を受けて).{0,10}(業務|作業)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "業務委託なのに委託者担当者の指示に従う規定。偽装請負の典型",
        "check_points": ["職業安定法44条違反", "労働者派遣法違反", "実態は雇用関係"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    # 偽装請負：9-18時勤務
    "fake_contract_work_hours": {
        "pattern": r"(受託者|乙).{0,10}(毎日|平日).{0,5}(\d+)\s*(時|:).{0,5}(から|〜|～).{0,5}(\d+)\s*(時|:).{0,10}(当社|甲|委託者).{0,10}(オフィス|事務所|事業所).{0,10}(業務|作業|勤務)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "業務委託なのに勤務時間・場所を指定。偽装請負の典型",
        "check_points": ["業務委託は時間・場所の拘束なしが原則", "出勤義務は雇用の徴表", "偽装請負（労働者派遣法違反）"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    # 偽装請負：出退勤管理
    "fake_contract_attendance": {
        "pattern": r"(受託者|乙).{0,5}(の|).{0,5}(出退勤|出勤|勤怠).{0,10}(当社|甲|委託者).{0,5}(の|).{0,5}(タイムカード|勤怠システム|出勤簿).{0,10}(管理|記録)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "業務委託なのに出退勤をタイムカード管理。偽装請負の典型",
        "check_points": ["出退勤管理は雇用関係の徴表", "業務委託は成果物納品が基本", "偽装請負（職業安定法44条違反）"],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
    # 管理職残業代なし
    "manager_no_overtime": {
        "pattern": r"(管理職|管理監督者).{0,10}(時間外|残業).{0,5}(労働|).{0,5}(手当|代).{0,10}(支給.{0,5}対象外|対象外|なし|支給しない)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "管理職の残業代不支給条項。「名ばかり管理職」問題に注意",
        "check_points": ["労基法41条2号の「管理監督者」該当性を確認", "経営と一体的な立場が必要", "深夜割増は管理監督者にも必要"],
        "legal_basis": "労働基準法41条2号"
    },
    # 遅刻で日給半額控除
    "late_half_day_deduction": {
        "pattern": r"(遅刻|欠勤).{0,5}(\d+)\s*(回|).{0,10}(につき|ごとに|した場合).{0,10}(日給|賃金).{0,5}(の|).{0,5}(半額|50%|2分の1).{0,10}(控除|減額)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "遅刻1回で日給半額控除。労基法91条（減給制裁の上限）違反の可能性",
        "check_points": ["労基法91条：1事案で平均賃金1日分の半額が上限", "遅刻時間相当を超える控除は違法", "制裁としての減給には上限あり"],
        "legal_basis": "労働基準法91条"
    },
    # 更新料3ヶ月分
    "renewal_fee_3months": {
        "pattern": r"(更新料|更新手数料).{0,10}(として|は|を).{0,10}(新|).{0,5}(賃料|家賃).{0,5}(の|).{0,5}3\s*(ヶ月|か月|カ月|箇月)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "更新料3ヶ月分。最高裁判例（平成23年7月15日）の射程を超える可能性",
        "check_points": ["最判平成23年7月15日は賃料1ヶ月分を有効と判示", "3ヶ月分は過大で無効の可能性", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    # 設備新品交換義務
    "equipment_new_replacement": {
        "pattern": r"(エアコン|給湯器|設備).{0,10}(新品|新しい).{0,5}(に|).{0,5}(交換|取替|入替).{0,10}(して|した上で).{0,5}(明渡|明け渡|返還)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "設備の新品交換義務。経年劣化した設備の新品交換を借主に求めるのは違法",
        "check_points": ["設備の経年劣化は貸主負担が原則", "新品交換義務は過大な負担", "国交省ガイドライン違反"],
        "legal_basis": "民法606条、消費者契約法10条"
    },
    # 手付金30%
    "hand_money_30pct": {
        "pattern": r"(売買.{0,5}代金|代金).{0,5}(の|).{0,5}30\s*(%|パーセント|％).{0,10}(手付金|手付).{0,5}(として|を).{0,5}(支払|払う)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "手付金30%条項。宅建業法39条（20%上限）違反",
        "check_points": ["宅建業法39条は手付金を代金の20%以内に制限", "超過部分は手付としての効力なし", "宅建業者からの購入時に適用"],
        "legal_basis": "宅建業法39条"
    },
    # FC中途解約絶対禁止
    "fc_no_cancel_absolute": {
        "pattern": r"(加盟店|フランチャイジー).{0,10}(契約期間中|期間中).{0,10}(いかなる|どのような).{0,10}(理由|事由).{0,10}(あっても|でも|においても).{0,10}(中途解約|解約).{0,10}(できない|できません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "契約期間中の中途解約絶対禁止条項。やむを得ない事由による解約は認められるべき",
        "check_points": ["中小小売商業振興法11条", "やむを得ない事由による解約権は剥奪できない", "民法651条類推"],
        "legal_basis": "中小小売商業振興法11条、民法651条"
    },
    # FC仕入先強制
    "fc_supplier_only": {
        "pattern": r"(加盟店|フランチャイジー).{0,10}(本部|甲).{0,10}(が|).{0,5}(決定|指定).{0,5}(した|する).{0,5}(仕入れ先|仕入先|業者).{0,10}(のみ|からのみ|以外.{0,5}認め).{0,10}(仕入|購入|調達)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "本部指定仕入先のみからの仕入強制。独禁法違反の可能性",
        "check_points": ["独占禁止法（拘束条件付取引）", "品質管理目的でも全面強制は問題", "価格差がある場合は特に注意"],
        "legal_basis": "独占禁止法"
    },
    # 下請支払い120日
    "subcontract_120days": {
        "pattern": r"(代金|報酬).{0,5}(の|).{0,5}(支払|支払い).{0,10}(検収|納品|受領).{0,5}(完了|後).{0,10}120\s*(日|営業日).{0,5}(以内|後|まで)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "120日後支払条項。下請法2条の2（60日以内）違反",
        "check_points": ["下請法は受領日から60日以内の支払義務", "120日は明確な違法", "公正取引委員会への相談を"],
        "legal_basis": "下請法2条の2"
    },
    # 発注取消補償なし
    "order_cancel_no_compensation": {
        "pattern": r"(当社|甲|発注者).{0,10}(都合|判断).{0,10}(により|で).{0,10}(発注|注文).{0,10}(取り消|取消|キャンセル).{0,10}(できる|できます).{0,15}(補償|賠償|費用).{0,10}(行わない|しない|なし)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的発注取消かつ補償なし条項。下請法4条違反",
        "check_points": ["下請法4条1項1号（受領拒否の禁止）", "取消しによる損害は賠償必要", "下請法4条2項4号"],
        "legal_basis": "下請法4条1項1号、4条2項4号"
    },
    # 単価引下げ一方的
    "price_cut_unilateral": {
        "pattern": r"(発注後|注文後|契約後).{0,10}(であっても|でも|においても).{0,10}(当社|甲|発注者).{0,5}(の|).{0,5}(判断|都合).{0,10}(単価|価格).{0,10}(引き下げ|引下げ|減額|変更)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注後の一方的単価引下げ条項。下請法4条1項5号違反",
        "check_points": ["下請法4条1項5号（買いたたきの禁止）", "発注後の減額は違法", "下請事業者の同意があっても問題となりうる"],
        "legal_basis": "下請法4条1項5号"
    },
    # 無償やり直し無制限
    "unlimited_free_redo": {
        "pattern": r"(成果物|納品物).{0,10}(修正|やり直し|手直し).{0,10}(が必要|必要な).{0,10}(場合|ときは).{0,10}(何度でも|無制限に|回数.{0,5}制限なく).{0,10}(無償|無料|費用なし).{0,10}(やり直し|修正|対応)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "無制限無償やり直し条項。下請法4条2項4号違反",
        "check_points": ["下請法4条2項4号（不当なやり直しの禁止）", "瑕疵のないものを無償でやり直させるのは違法", "回数・範囲の制限が必要"],
        "legal_basis": "下請法4条2項4号"
    },
    # 競業避止5年いかなる同業他社
    "non_compete_5y_any": {
        "pattern": r"(退職後|離職後).{0,5}(\d+)\s*(年|年間).{0,10}(いかなる|すべて|全て).{0,10}(同業他社|同業|競合).{0,10}(就労|勤務|就職)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "長期間・全同業他社への就労禁止。職業選択の自由を過度に制限",
        "check_points": ["5年は過度に長い（判例は1-2年が上限）", "「いかなる」同業他社は範囲が広すぎる", "公序良俗違反で無効"],
        "legal_basis": "憲法22条、民法90条"
    },
    # 退職後いかなる同業種勤務禁止
    "no_work_any_industry": {
        "pattern": r"(退職後|離職後).{0,10}(いかなる|すべて|全て).{0,10}(同業種|同業|競合).{0,5}(の|).{0,5}(会社|企業).{0,10}(勤務|就労|従事).{0,10}(できない|できません|禁止)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "全同業種への勤務禁止。職業選択の自由を過度に制限し無効",
        "check_points": ["期間・地域・対象企業の限定が必要", "「いかなる同業種」は範囲が広すぎる", "憲法22条違反"],
        "legal_basis": "憲法22条、民法90条"
    },
    # 更新料新賃料3ヶ月分
    "renewal_3m_new_rent": {
        "pattern": r"(契約.{0,3}更新|更新).{0,10}(時|の際).{0,10}(新.{0,3}賃料|賃料|家賃).{0,5}(の|).{0,5}(\d+)\s*(ヶ月|か月|カ月).{0,5}(分|).{0,5}(を|).{0,5}(更新料|として)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "更新料3ヶ月分条項。最高裁判例の射程を超え無効の可能性大",
        "check_points": ["最判平成23年7月15日は1ヶ月分を有効と判示", "3ヶ月分は過大", "消費者契約法10条で無効の可能性"],
        "legal_basis": "消費者契約法10条",
        "validate": lambda m: int(m.group(5)) >= 3
    },
    # 発注取消補償なし（表現違い）
    "order_cancel_v2": {
        "pattern": r"(当社|甲|発注者).{0,10}(都合|判断|理由).{0,10}(により|で).{0,10}(発注|注文).{0,10}(取り消|取消).{0,15}(補償|賠償).{0,10}(行わない|しない|なし|いたしません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的発注取消かつ補償なし条項。下請法4条違反",
        "check_points": ["下請法4条1項1号（受領拒否の禁止）", "発注取消による損害は賠償必要", "「この場合、補償は行いません」は違法"],
        "legal_basis": "下請法4条1項1号、4条2項4号"
    },
    # 発注取消+この場合補償なし
    "order_cancel_no_comp_v3": {
        "pattern": r"(発注|注文).{0,10}(取り消|取消).{0,10}(できます|することができ|可能).{0,10}この場合.{0,10}(補償|賠償).{0,10}(行い|し).{0,5}(ません|ない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "発注取消時に補償なしとする条項。下請法4条違反",
        "check_points": ["下請法4条1項1号（受領拒否の禁止）", "発注取消による損害は賠償が必要", "下請法4条2項4号"],
        "legal_basis": "下請法4条1項1号、4条2項4号"
    },
}

# =============================================================================
# 業界約款対応パターン
# =============================================================================

INDUSTRY_PATTERNS = {
    # -------------------------------------------------------------------------
    # 金融業界
    # -------------------------------------------------------------------------
    "bank_no_principal_guarantee": {
        "pattern": r"(元本|元金).{0,10}(保証|担保).{0,10}(するもの|しているもの).{0,5}(ではなく|ではありません).{0,10}(投資元本|元本).{0,10}(下回|毀損)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "元本保証なし条項。投資商品の本質だが、適合性原則の確認が必要",
        "check_points": ["金融商品販売法の説明義務", "適合性原則の遵守", "リスク説明の十分性"],
        "legal_basis": "金融商品販売法、金融商品取引法40条"
    },
    "bank_unilateral_rate_change": {
        "pattern": r"(当行|当社|金融機関).{0,10}(金利|利率).{0,10}(任意に|自由に|いつでも|一方的に).{0,10}(変更|改定).{0,15}(お客様|顧客).{0,10}(通知|連絡).{0,10}(行い|し).{0,5}(ません|ない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一方的金利変更かつ通知なし条項。消費者契約法10条違反",
        "check_points": ["金利変更は事前通知が必要", "消費者契約法10条", "民法548条の4"],
        "legal_basis": "消費者契約法10条、民法548条の4"
    },
    "insurance_minor_breach_cancel": {
        "pattern": r"(告知|申告).{0,10}(内容|事項).{0,10}(虚偽|誤り|相違).{0,10}(あった場合|があれば).{0,10}(軽微|些細|わずか).{0,10}(事項|).{0,5}(であっても|でも).{0,10}(契約.{0,5}解除|解除)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "軽微な告知義務違反でも解除可能とする条項。保険法28条違反",
        "check_points": ["保険法28条（因果関係要件）", "軽微な違反での解除は無効", "保険法31条（解除権の制限）"],
        "legal_basis": "保険法28条、31条"
    },
    "card_high_late_fee": {
        "pattern": r"(支払.{0,3}遅延|延滞|滞納).{0,10}(場合|した場合|のとき).{0,10}(年率|年).{0,5}(\d{2}|\d{1}\.\d).{0,5}(%|パーセント).{0,10}(遅延損害金|損害金)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "高率の遅延損害金。利息制限法の上限（年20%）を超える場合は違法",
        "check_points": ["利息制限法の上限は年20%", "20%超は無効", "出資法の上限も確認"],
        "legal_basis": "利息制限法4条"
    },
    "card_stop_no_reason": {
        "pattern": r"(当社|カード会社).{0,10}(理由.{0,5}開示.{0,5}(しない|なく|することなく)|理由なく).{0,10}(カード|利用).{0,10}(停止|利用停止)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "理由開示なしの一方的カード停止条項。消費者契約法10条違反",
        "check_points": ["消費者契約法10条", "利用停止の正当理由が必要", "異議申立の機会確保"],
        "legal_basis": "消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # 通信業界
    # -------------------------------------------------------------------------
    "telecom_high_cancel_fee": {
        "pattern": r"(契約期間中|期間内).{0,10}(解約|解除).{0,10}(には|の場合).{0,10}(残存期間|残り).{0,10}(関わらず|問わず).{0,10}(一律|定額).{0,10}(\d+).{0,5}(円|万円)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一律高額解約金条項。電気通信事業法・消費者契約法9条違反の可能性",
        "check_points": ["電気通信事業法の上限規制（月額相当額）", "消費者契約法9条1号", "平均的損害を超える部分は無効"],
        "legal_basis": "電気通信事業法、消費者契約法9条1号"
    },
    "telecom_device_lump_sum": {
        "pattern": r"(解約時|解約の際).{0,10}(分割払い中|割賦).{0,10}(端末|機器).{0,5}(代金|残金).{0,10}(一括|全額).{0,10}(お支払い|支払|請求)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "解約時の端末代一括請求条項。期限の利益喪失条項として問題の可能性",
        "check_points": ["消費者契約法9条1号との関係", "端末代と通信契約は別", "一括請求の合理性"],
        "legal_basis": "消費者契約法9条1号"
    },
    "isp_no_speed_guarantee": {
        "pattern": r"(回線.{0,3}速度|通信速度|速度).{0,10}(最大値|理論値|ベストエフォート).{0,10}(であり|で).{0,10}(実際の速度|速度).{0,10}(保証|担保).{0,10}(しない|しません).{0,10}(いかなる|一切).{0,10}(返金|返還).{0,10}(応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "速度保証なし+返金拒否条項。著しい速度低下時も救済なしは問題",
        "check_points": ["ベストエフォートでも著しい低下は問題", "契約の本旨との関係", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    "isp_full_construction_fee": {
        "pattern": r"(工事費|設置費|初期費用).{0,10}(解約時|解約した場合).{0,10}(残額|未払|全額).{0,10}(一括|全て).{0,10}(請求|お支払い)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "解約時の工事費残額一括請求。短期解約でも全額請求は問題の可能性",
        "check_points": ["消費者契約法9条1号", "工事費の実費との乖離", "長期契約の場合は減額すべき"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # -------------------------------------------------------------------------
    # 運送業界
    # -------------------------------------------------------------------------
    "delivery_low_compensation": {
        "pattern": r"(賠償|補償).{0,10}(上限|限度).{0,10}(は|を).{0,10}(\d+).{0,5}(万円|円).{0,10}(とし|限り|まで)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "低額の賠償上限条項。高額品の場合は問題の可能性",
        "check_points": ["運送約款の相当性", "高額品の申告制度の有無", "故意・重過失の場合は上限無効"],
        "legal_basis": "商法577条、消費者契約法8条"
    },
    "airline_overbooking": {
        "pattern": r"(オーバーブッキング|過剰予約|座席不足).{0,10}(場合|により).{0,10}(搭乗|利用).{0,10}(できない|拒否|不可).{0,10}(こと|場合).{0,10}(あり|承諾)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "オーバーブッキング条項。代替便や補償の規定が必要",
        "check_points": ["代替便の手配義務", "補償金の規定", "EU規則では明確な補償義務"],
        "legal_basis": "航空法、消費者契約法10条"
    },
    "airline_baggage_waiver": {
        "pattern": r"(手荷物|受託手荷物|預け荷物).{0,10}(紛失|破損|遅延).{0,10}(一切|いかなる).{0,10}(責任|賠償).{0,10}(負わない|負いません|免責)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "手荷物の一切免責条項。消費者契約法8条違反",
        "check_points": ["消費者契約法8条（全面免責の無効）", "モントリオール条約の適用", "故意・重過失の除外なし"],
        "legal_basis": "消費者契約法8条、モントリオール条約"
    },
    
    # -------------------------------------------------------------------------
    # 旅行業界
    # -------------------------------------------------------------------------
    "travel_weather_waiver": {
        "pattern": r"(天候|天災|自然災害|悪天候).{0,10}(による|起因する|に起因).{0,10}(旅程|日程|サービス).{0,10}(変更|中止|キャンセル).{0,10}(一切|いかなる).{0,10}(責任|賠償|補償).{0,10}(負わない|負いません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "天候による一切免責条項。旅行業法上の責任を全面排除は問題",
        "check_points": ["旅行業法の旅程管理義務", "消費者契約法8条", "代替手配の義務"],
        "legal_basis": "旅行業法、消費者契約法8条"
    },
    "hotel_100pct_same_day": {
        "pattern": r"(当日|チェックイン日).{0,10}(キャンセル|取消).{0,10}(場合|のとき).{0,10}(宿泊料|料金).{0,10}(100|全額).{0,5}(%|パーセント).{0,10}(キャンセル料|いただき)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "当日キャンセル100%条項。平均的損害との関係で問題の可能性",
        "check_points": ["消費者契約法9条1号", "当日でも部屋を再販売できる場合は問題", "業界慣行との比較"],
        "legal_basis": "消費者契約法9条1号"
    },
    "hotel_overbooking": {
        "pattern": r"(オーバーブッキング|予約超過|部屋不足).{0,10}(場合|により).{0,10}(宿泊|ご利用).{0,10}(できない|不可|お断り).{0,10}(こと|場合).{0,10}(あり|承諾|ご了承)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "オーバーブッキング条項。代替宿泊施設の手配義務が必要",
        "check_points": ["債務不履行責任", "代替施設の手配義務", "消費者契約法10条"],
        "legal_basis": "民法415条、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # 医療介護業界
    # -------------------------------------------------------------------------
    "medical_no_result_guarantee": {
        "pattern": r"(医療|治療|施術).{0,10}(結果|効果|成果).{0,10}(一切|いかなる).{0,10}(保証|担保).{0,10}(するもの|しているもの).{0,5}(ではなく|ではありません)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "医療結果の一切不保証条項。説明義務との関係で問題の可能性",
        "check_points": ["医療法の説明義務", "期待権の侵害", "過度に広い免責は問題"],
        "legal_basis": "医療法、消費者契約法8条"
    },
    "cosmetic_high_cancel": {
        "pattern": r"(美容.{0,3}医療|美容整形|エステ).{0,10}(キャンセル|解約).{0,10}(場合|した場合).{0,10}(施術.{0,3}料金|料金|代金).{0,5}(の|).{0,5}(\d{2,3})\s*(%|パーセント)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "美容医療の高額キャンセル料。特定商取引法・消費者契約法9条違反の可能性",
        "check_points": ["特定商取引法の中途解約権", "消費者契約法9条1号", "50%超は過大の可能性"],
        "legal_basis": "特定商取引法49条、消費者契約法9条1号"
    },
    "nursing_immediate_eviction": {
        "pattern": r"(施設|事業者|当方).{0,10}(判断|都合).{0,10}(により|で).{0,10}(即時|直ちに|速やかに).{0,10}(退去|退所|契約解除).{0,10}(求め|要求)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "介護施設の即時退去条項。高齢者の居住の安定を著しく害する",
        "check_points": ["老人福祉法の趣旨", "高齢者居住安定確保法", "正当事由・猶予期間が必要"],
        "legal_basis": "老人福祉法、高齢者居住安定確保法、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # 教育業界
    # -------------------------------------------------------------------------
    "school_no_grade_guarantee": {
        "pattern": r"(成績|学力|結果).{0,10}(向上|上昇|改善).{0,10}(一切|いかなる).{0,10}(保証|担保).{0,10}(するもの|しているもの).{0,5}(ではなく|ではありません)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "成績保証なし条項。教育サービスの本質的義務との関係で問題の可能性",
        "check_points": ["サービス提供義務との関係", "過度に広い免責は問題", "消費者契約法8条"],
        "legal_basis": "消費者契約法8条"
    },
    "course_expiry_no_refund": {
        "pattern": r"(受講.{0,3}期限|有効期限|受講期間).{0,10}(経過|過ぎ|切れ).{0,10}(した場合|た場合|た後).{0,10}(受講|利用).{0,10}(できない|不可).{0,10}(返金|返還).{0,10}(応じ|しない|しません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "受講期限切れで返金なし条項。未受講分の返金拒否は消費者契約法9条違反",
        "check_points": ["消費者契約法9条1号", "特定商取引法の中途解約権", "未受講分は返金が原則"],
        "legal_basis": "特定商取引法49条、消費者契約法9条1号"
    },
    "course_material_mandatory": {
        "pattern": r"(教材|テキスト|資料).{0,10}(買取|購入).{0,10}(必須|義務|しなければ).{0,10}(返品|返金|キャンセル).{0,10}(不可|できない|応じ)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "教材強制購入+返品不可条項。特定商取引法違反の可能性",
        "check_points": ["特定商取引法の中途解約権", "クーリングオフ対象の場合は教材も返品可", "消費者契約法10条"],
        "legal_basis": "特定商取引法、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # EC・小売業界
    # -------------------------------------------------------------------------
    "ec_no_return": {
        "pattern": r"(商品|製品).{0,10}(到着|受領|納品).{0,10}(後|した後).{0,10}(いかなる|一切|どのような).{0,10}(理由|場合).{0,10}(でも|においても|も).{0,10}(返品|返金|交換).{0,10}(応じ|受付|できない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "一切返品不可条項。特定商取引法・消費者契約法違反の可能性",
        "check_points": ["特定商取引法の返品特約表示義務", "消費者契約法10条", "瑕疵担保責任は排除不可"],
        "legal_basis": "特定商取引法15条の3、消費者契約法10条"
    },
    "ec_price_change": {
        "pattern": r"(商品|製品).{0,10}(価格|料金).{0,10}(予告なく|事前.{0,5}通知.{0,5}なく|いつでも).{0,10}(変更|改定).{0,10}(できる|する|いたし)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "予告なし価格変更条項。購入確定後の変更は問題",
        "check_points": ["購入確定前の価格変更は可", "確定後の変更は債務不履行", "消費者契約法10条"],
        "legal_basis": "民法415条、消費者契約法10条"
    },
    "retail_personal_info": {
        "pattern": r"(個人情報|お客様情報|顧客情報).{0,10}(当社|弊社|グループ会社|第三者).{0,10}(マーケティング|広告|販促|営業).{0,10}(目的|用途).{0,10}(で|に).{0,10}(利用|使用|活用)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "個人情報のマーケティング利用条項。オプトイン同意が必要",
        "check_points": ["個人情報保護法の利用目的制限", "本人同意の取得方法", "オプトアウトの機会"],
        "legal_basis": "個人情報保護法18条、20条"
    },
    "retail_point_expiry": {
        "pattern": r"(ポイント|マイル).{0,10}(有効期限|期限).{0,10}(経過|過ぎ|切れ).{0,10}(した場合|た場合).{0,10}(失効|消滅|無効).{0,10}(復活|返還).{0,10}(できない|しない|応じ)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "ポイント失効条項。合理的な期間設定と事前通知が必要",
        "check_points": ["有効期限の合理性", "失効前の事前通知", "消費者契約法10条との関係"],
        "legal_basis": "消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # エネルギー業界
    # -------------------------------------------------------------------------
    "energy_high_cancel": {
        "pattern": r"(電力|ガス|電気).{0,10}(契約|サービス).{0,10}(解約|解除).{0,10}(場合|した場合).{0,10}(違約金|解約金|手数料).{0,10}(として|を).{0,10}(\d+).{0,5}(円|万円)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "電力・ガス解約金条項。経済産業省ガイドラインで上限あり",
        "check_points": ["電気事業法・ガス事業法", "経産省ガイドラインの上限", "消費者契約法9条1号"],
        "legal_basis": "電気事業法、消費者契約法9条1号"
    },
    "energy_rate_change": {
        "pattern": r"(電力|ガス|電気).{0,10}(料金|単価|基本料).{0,10}(当社|弊社|事業者).{0,10}(判断|都合).{0,10}(により|で).{0,10}(変更|改定).{0,10}(できる|する)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "一方的料金変更条項。規制料金か自由料金かで判断が異なる",
        "check_points": ["電気事業法の規制", "変更の事前通知義務", "消費者契約法10条"],
        "legal_basis": "電気事業法、消費者契約法10条"
    },
    "gas_construction_burden": {
        "pattern": r"(工事費|設置費|取付費).{0,10}(全額|すべて|一切).{0,10}(お客様|利用者|契約者).{0,10}(負担|ご負担)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "工事費全額顧客負担条項。供給義務との関係で問題の可能性",
        "check_points": ["ガス事業法の供給義務", "工事費負担の合理性", "消費者契約法10条"],
        "legal_basis": "ガス事業法、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # 建設業界
    # -------------------------------------------------------------------------
    "construction_full_extra_cost": {
        "pattern": r"(追加.{0,3}工事|追加.{0,3}費用|変更.{0,3}工事).{0,10}(発生した場合|の場合|が生じた場合).{0,10}(全額|すべて).{0,10}(発注者|施主|お客様).{0,10}(負担|ご負担)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "追加工事費用全額発注者負担条項。説明・合意なき追加費用は問題",
        "check_points": ["建設業法の見積書交付義務", "事前説明・合意が必要", "消費者契約法10条"],
        "legal_basis": "建設業法20条、消費者契約法10条"
    },
    "construction_short_warranty": {
        "pattern": r"(瑕疵担保|契約不適合|保証).{0,10}(期間|責任).{0,10}(は|を).{0,10}(引渡し|完成).{0,10}(から|後).{0,5}(\d+)\s*(ヶ月|か月|年)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "瑕疵担保期間短縮条項。民法の10年より短縮する場合は注意",
        "check_points": ["住宅品確法の10年保証", "民法637条", "構造耐力上主要な部分は10年"],
        "legal_basis": "住宅品確法94条、民法637条"
    },
    "reform_high_cancel": {
        "pattern": r"(リフォーム|改修|工事).{0,10}(契約.{0,3}解除|キャンセル).{0,10}(場合|した場合).{0,10}(工事.{0,3}代金|契約.{0,3}金額).{0,5}(の|).{0,5}(\d{2,3})\s*(%|パーセント)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "リフォーム工事の高額キャンセル料。消費者契約法9条1号違反の可能性",
        "check_points": ["消費者契約法9条1号", "着工前は低率であるべき", "平均的損害の立証"],
        "legal_basis": "消費者契約法9条1号"
    },
    "reform_no_design_change": {
        "pattern": r"(設計|仕様|プラン).{0,10}(変更|修正).{0,10}(一切|いかなる場合も).{0,10}(応じ|受付|できない)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "設計変更一切拒否条項。合理的な変更要望は対応すべき",
        "check_points": ["消費者契約法10条", "契約の本旨との関係", "追加費用での対応は可"],
        "legal_basis": "消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # SaaS・クラウド追加
    # -------------------------------------------------------------------------
    "saas_data_ownership": {
        "pattern": r"(ユーザー|利用者|お客様).{0,10}(データ|情報|コンテンツ).{0,10}(所有権|権利).{0,10}(当社|サービス提供者).{0,10}(に帰属|に移転|が保有)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "ユーザーデータの所有権が事業者に帰属する条項。著作権法・消費者契約法違反",
        "check_points": ["ユーザーデータの所有権はユーザーが原則", "著作権法の原則", "消費者契約法10条"],
        "legal_basis": "著作権法、消費者契約法10条"
    },
    "cloud_data_delete": {
        "pattern": r"(契約.{0,3}終了|解約|サービス.{0,3}終了).{0,10}(後|した場合).{0,10}(データ|情報).{0,10}(直ちに|速やかに|自動的に|即時).{0,10}(削除|消去)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "契約終了後のデータ即時削除条項。データエクスポートの猶予が必要",
        "check_points": ["データ取得の機会確保", "合理的な猶予期間が必要", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    "cloud_capacity_change": {
        "pattern": r"(ストレージ|容量|保存.{0,3}領域).{0,10}(当社|サービス提供者).{0,10}(判断|都合).{0,10}(により|で).{0,10}(変更|削減|縮小)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "一方的な容量変更条項。サービス内容の一方的変更は問題",
        "check_points": ["契約内容の一方的変更", "消費者契約法10条", "民法548条の4"],
        "legal_basis": "消費者契約法10条、民法548条の4"
    },
    "b2b_sla_waiver": {
        "pattern": r"(SLA|サービスレベル|稼働率|可用性).{0,10}(未達|下回|達成.{0,5}できない).{0,10}(場合|ときは|も).{0,10}(一切|いかなる).{0,10}(責任|賠償|補償).{0,10}(負わない|負いません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "SLA未達時の一切免責条項。契約の本旨に反する",
        "check_points": ["SLA保証は契約の重要部分", "全面免責は無効", "消費者契約法8条"],
        "legal_basis": "消費者契約法8条、民法415条"
    },
    "b2b_cancel_restriction": {
        "pattern": r"(契約期間中|期間.{0,3}満了.{0,3}前).{0,10}(解約|解除).{0,10}(一切|いかなる理由でも|認め).{0,5}(ない|ません|できない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "契約期間中の解約一切禁止条項。やむを得ない事由による解約は認められるべき",
        "check_points": ["民法651条（委任の解除）類推", "やむを得ない事由による解約権", "消費者契約法10条"],
        "legal_basis": "民法651条、消費者契約法10条"
    },
    
    # -------------------------------------------------------------------------
    # FALSE_OK解消用追加パターン（業界約款テスト対応）
    # -------------------------------------------------------------------------
    
    # ポイント予告なし失効
    "point_no_notice_expiry": {
        "pattern": r"(ポイント).{0,10}(予告.{0,5}なく|事前.{0,5}通知.{0,5}なく).{0,10}(失効|消滅|無効)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "予告なしポイント失効条項。消費者契約法10条違反の可能性",
        "check_points": ["失効前の事前通知義務", "消費者契約法10条", "民法1条2項（信義則）"],
        "legal_basis": "消費者契約法10条"
    },
    "point_no_compensation": {
        "pattern": r"(失効|消滅).{0,10}(ポイント).{0,10}(補償|返還|復活).{0,10}(行い|し).{0,5}(ません|ない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "失効ポイント補償拒否条項。予告なし失効と組み合わさると消費者契約法10条違反",
        "check_points": ["失効の正当理由", "消費者契約法10条", "事前通知の有無"],
        "legal_basis": "消費者契約法10条"
    },
    
    # B2B年間契約解約制限
    "annual_contract_no_midterm_cancel": {
        "pattern": r"(年間契約|年間).{0,10}(中途解約|途中解約|解約).{0,10}(認め).{0,5}(ません|ない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "年間契約中途解約禁止条項。やむを得ない事由による解約権を不当に制限",
        "check_points": ["民法651条類推（やむを得ない事由）", "消費者契約法9条1号", "解約権の不当制限"],
        "legal_basis": "消費者契約法9条1号、民法651条"
    },
    "annual_full_payment_on_cancel": {
        "pattern": r"(解約).{0,10}(希望|場合|しても).{0,10}(年間利用料|年間料金|契約金額).{0,10}(全額|100).{0,5}(%|パーセント)?.{0,10}(お支払い|支払|いただき)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "解約時の年間料金全額請求条項。平均的損害を超える違約金として消費者契約法9条1号違反",
        "check_points": ["消費者契約法9条1号", "平均的損害の算定", "残期間に応じた減額なし"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # ISP工事費（v2）
    "isp_construction_double": {
        "pattern": r"(工事費|初期費用).{0,10}(残債|残額).{0,10}(加え|に加えて|プラス).{0,10}(違約金|解約金)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "工事費残債+違約金として工事費相当額の二重請求条項。消費者契約法9条違反",
        "check_points": ["消費者契約法9条1号", "平均的損害を超える", "二重取りは無効"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # 宅配賠償（v2）
    "delivery_low_limit_v2": {
        "pattern": r"(紛失|破損|遅延).{0,10}(賠償|補償).{0,10}(申告|申出).{0,10}(有無|の有無).{0,10}(かかわらず|問わず).{0,10}(\d+).{0,5}(万円|円).{0,10}(上限|を上限)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "申告有無にかかわらず低額賠償上限条項。高額品被害時に不利益",
        "check_points": ["故意・重過失時は上限無効", "高額品の場合は問題", "標準約款との比較"],
        "legal_basis": "商法577条、消費者契約法8条"
    },
    
    # 航空オーバーブッキング（v2）
    "airline_overbooking_v2": {
        "pattern": r"(予約超過|予約.{0,5}超).{0,10}(場合|の場合).{0,10}(当社|航空会社).{0,10}(判断).{0,10}(搭乗|乗機).{0,10}(お断り|拒否)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "オーバーブッキング時の搭乗拒否条項。補償規定の明確化が必要",
        "check_points": ["補償金の規定が必要", "代替便の手配義務", "航空法・消費者契約法"],
        "legal_basis": "航空法、消費者契約法10条"
    },
    
    # 旅行天候免責（v2）
    "travel_weather_no_comp_v2": {
        "pattern": r"(天候.{0,3}不良|悪天候|天災).{0,10}(による|起因).{0,10}(変更|中止).{0,10}(について|に対し).{0,10}(一切|いかなる).{0,10}(補償|賠償).{0,10}(行い|しない|いたし)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "天候による変更・中止で一切補償なし条項。消費者契約法8条違反",
        "check_points": ["消費者契約法8条", "旅行業法の保護義務", "全面免責は無効"],
        "legal_basis": "旅行業法、消費者契約法8条"
    },
    
    # 宿泊当日100%（v2）
    "hotel_sameday_100_v2": {
        "pattern": r"(当日|チェックイン.{0,3}日).{0,10}(キャンセル|取消).{0,10}(理由.{0,5}問わず|理由を問わず).{0,10}(宿泊料|料金).{0,10}(100|全額)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "当日キャンセルで理由問わず100%請求条項。やむを得ない事由は考慮すべき",
        "check_points": ["消費者契約法9条1号", "当日でも部屋再販売可能な場合あり", "やむを得ない事由の考慮"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # 医療結果保証なし（v2）
    "medical_no_guarantee_v2": {
        "pattern": r"(治療|施術).{0,10}(結果).{0,10}(一切).{0,10}(保証).{0,10}(せず|しない).{0,10}(いかなる|どのような).{0,10}(場合).{0,10}(返金).{0,10}(応じ)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "治療結果一切不保証+返金拒否条項。説明義務違反・期待権侵害の可能性",
        "check_points": ["医療法の説明義務", "過度に広い免責は問題", "消費者契約法8条"],
        "legal_basis": "医療法、消費者契約法8条"
    },
    
    # 美容医療高額キャンセル（v2）
    "cosmetic_cancel_full_v2": {
        "pattern": r"(施術.{0,3}予約|予約).{0,10}(キャンセル|取消).{0,10}(理由.{0,5}問わず|理由を問わず).{0,10}(施術.{0,3}費用|費用|代金).{0,10}(全額)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "施術予約キャンセルで全額請求条項。消費者契約法9条1号違反",
        "check_points": ["消費者契約法9条1号", "特定商取引法の中途解約権", "平均的損害を超える"],
        "legal_basis": "消費者契約法9条1号、特定商取引法49条"
    },
    
    # 塾成績保証なし（v2）
    "school_no_guarantee_v2": {
        "pattern": r"(成績.{0,3}向上|成績.{0,3}上昇).{0,10}(保証).{0,10}(するもの|しているもの).{0,5}(ではなく|ではありません|ではない).{0,10}(結果).{0,10}(かかわらず|問わず).{0,10}(返金).{0,10}(応じ)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "成績保証なし+結果問わず返金拒否条項。サービス提供義務との関係",
        "check_points": ["サービス提供義務", "過度に広い免責は問題", "消費者契約法8条"],
        "legal_basis": "消費者契約法8条"
    },
    
    # 講座期限切れ（v2）
    "course_expiry_v2": {
        "pattern": r"(受講.{0,3}期限|受講期限).{0,10}(過ぎ|経過|切れ).{0,10}(場合|た場合).{0,10}(未視聴|未受講).{0,10}(あっても|があっても).{0,10}(返金).{0,10}(しない|いたし)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "受講期限切れで未受講分も返金なし条項。消費者契約法9条違反",
        "check_points": ["消費者契約法9条1号", "未受講分は返金が原則", "特定商取引法"],
        "legal_basis": "消費者契約法9条1号、特定商取引法49条"
    },
    
    # EC返品不可（v2）
    "ec_no_return_v2": {
        "pattern": r"(商品.{0,3}到着|到着).{0,10}(後).{0,10}(返品|交換).{0,10}(理由.{0,5}問わず|理由を問わず).{0,10}(一切).{0,10}(受け|お受け).{0,10}(いたし|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "理由問わず一切返品不可条項。特定商取引法・消費者契約法違反",
        "check_points": ["特定商取引法の返品特約表示義務", "瑕疵担保責任は排除不可", "消費者契約法10条"],
        "legal_basis": "特定商取引法15条の3、消費者契約法10条"
    },
    
    # EC価格変更（v2）
    "ec_price_change_v2": {
        "pattern": r"(注文.{0,3}確定|注文確定).{0,10}(後|した後).{0,10}(であっても|でも).{0,10}(当社|弊社).{0,10}(判断).{0,10}(価格).{0,10}(変更)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "注文確定後の一方的価格変更条項。契約成立後の変更は債務不履行",
        "check_points": ["契約成立後の変更は無効", "債務不履行責任", "消費者契約法10条"],
        "legal_basis": "民法415条、消費者契約法10条"
    },
    
    # 電力高額解約金（v2）
    "energy_high_cancel_v2": {
        "pattern": r"(契約期間.{0,3}内|期間内).{0,10}(解約).{0,10}(残存.{0,3}月数|残り).{0,10}(×|かける).{0,10}(基本料金).{0,10}(×|かける).{0,10}(2倍|倍)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "残存月数×基本料金×2倍の解約金条項。平均的損害を大幅に超過",
        "check_points": ["消費者契約法9条1号", "経産省ガイドライン上限", "2倍は過大"],
        "legal_basis": "消費者契約法9条1号、電気事業法"
    },
    
    # 建設追加費用（v2）
    "construction_extra_v2": {
        "pattern": r"(工事中|工事の途中).{0,10}(発生).{0,10}(追加.{0,3}費用|追加費用).{0,10}(見積.{0,3}有無|見積もりの有無).{0,10}(かかわらず|問わず).{0,10}(全額).{0,10}(お客様|発注者)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "見積もり有無にかかわらず追加費用全額負担条項。説明・合意なき請求は問題",
        "check_points": ["建設業法の見積書交付義務", "事前説明・合意が必要", "消費者契約法10条"],
        "legal_basis": "建設業法20条、消費者契約法10条"
    },
    
    # リフォーム高額キャンセル（v2）
    "reform_cancel_full_v2": {
        "pattern": r"(着工.{0,3}後|着工後).{0,10}(キャンセル|解約).{0,10}(工事.{0,3}完了|完了).{0,10}(有無|の有無).{0,10}(かかわらず|問わず).{0,10}(契約.{0,3}金額|金額).{0,10}(全額)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "工事完了有無にかかわらず契約金額全額請求条項。消費者契約法9条違反",
        "check_points": ["消費者契約法9条1号", "出来高に応じた精算が原則", "全額は過大"],
        "legal_basis": "消費者契約法9条1号"
    },
    
    # SaaSデータ所有権（v2）
    "saas_data_ownership_v2": {
        "pattern": r"(本サービス.{0,3}上|サービス上).{0,10}(作成).{0,10}(すべての|全ての).{0,10}(データ).{0,10}(所有権).{0,10}(当社).{0,10}(帰属)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "サービス上で作成された全データの所有権が事業者に帰属する条項。著作権法違反",
        "check_points": ["著作権法の原則（創作者に帰属）", "ユーザーデータはユーザーの財産", "消費者契約法10条"],
        "legal_basis": "著作権法、消費者契約法10条"
    },
    
    # クラウドデータ削除（v2）
    "cloud_data_delete_v2": {
        "pattern": r"(解約.{0,3}後|解約後).{0,10}(\d+).{0,3}(日).{0,10}(データ).{0,10}(完全.{0,3}削除|削除).{0,10}(バックアップ|復元).{0,10}(対応).{0,10}(しない|しません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "解約後短期間でデータ完全削除・復元不可条項。データエクスポート猶予が必要",
        "check_points": ["データ取得の機会確保", "30日は短すぎる可能性", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    
    # 航空手荷物貴重品免責
    "airline_valuables_no_comp": {
        "pattern": r"(手荷物|荷物).{0,10}(紛失|破損).{0,10}(貴重品).{0,10}(一切|いかなる).{0,10}(補償|賠償).{0,10}(しない|しません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "貴重品の紛失破損一切補償なし条項。消費者契約法8条違反",
        "check_points": ["消費者契約法8条", "故意・重過失の場合は免責不可", "モントリオール条約"],
        "legal_basis": "消費者契約法8条、モントリオール条約"
    },
    
    # 宿泊オーバーブッキング（v2）
    "hotel_overbooking_cancel": {
        "pattern": r"(予約.{0,3}超過|予約超過).{0,10}(場合|の場合).{0,10}(当方|当社).{0,10}(判断).{0,10}(予約).{0,10}(キャンセル)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "予約超過時の一方的予約キャンセル条項。債務不履行責任・補償義務がある",
        "check_points": ["債務不履行責任", "代替施設手配義務", "消費者契約法10条"],
        "legal_basis": "民法415条、消費者契約法10条"
    },
    
    # 講座教材買取（中途解約時）
    "course_material_full_v2": {
        "pattern": r"(中途.{0,3}解約|中途解約).{0,10}(場合|の場合).{0,10}(でも|であっても).{0,10}(教材費|教材).{0,10}(全額).{0,10}(お支払い|支払)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "中途解約でも教材費全額請求条項。特定商取引法違反の可能性",
        "check_points": ["特定商取引法の中途解約権", "クーリングオフ対象は教材も返品可", "未使用教材の返金"],
        "legal_basis": "特定商取引法49条"
    },
    
    # 小売個人情報無制限利用
    "retail_info_unlimited": {
        "pattern": r"(お客様|顧客).{0,10}(個人情報).{0,10}(当社|弊社).{0,10}(および|と).{0,10}(関連会社).{0,10}(営業活動|マーケティング).{0,10}(無制限).{0,10}(利用|使用)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "個人情報の無制限利用条項。個人情報保護法18条・20条違反",
        "check_points": ["個人情報保護法の利用目的制限", "無制限利用は違法", "本人同意の範囲逸脱"],
        "legal_basis": "個人情報保護法18条、20条"
    },
    
    # 小売ポイント予告なし失効
    "retail_point_sudden_expiry": {
        "pattern": r"(ポイント).{0,10}(予告.{0,3}なく|予告なく|事前.{0,5}通知.{0,5}なく).{0,10}(失効|消滅|無効).{0,10}(補償).{0,10}(行い|しない|しません)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "ポイント予告なし失効+補償なし条項。消費者契約法10条違反",
        "check_points": ["失効前の事前通知義務", "補償なしは消費者不利益", "消費者契約法10条"],
        "legal_basis": "消費者契約法10条"
    },
    
    # リフォーム設計変更拒否（v2）
    "reform_design_refuse_v2": {
        "pattern": r"(契約.{0,3}後|契約後).{0,10}(設計.{0,3}変更|設計変更).{0,10}(一切).{0,10}(お受け|受け|応じ).{0,10}(いたし|しない|しません)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "契約後の設計変更一切拒否条項。合理的変更は対応すべき",
        "check_points": ["消費者契約法10条", "契約の本旨との関係", "追加費用での対応は可"],
        "legal_basis": "消費者契約法10条"
    },
    
    # B2B SLA免責（v2）
    "b2b_sla_indirect_waiver": {
        "pattern": r"(SLA|稼働率).{0,10}(下回|未達|達成.{0,5}できない).{0,10}(場合).{0,10}(でも|であっても).{0,10}(直接.{0,3}損害.{0,3}以外|間接損害).{0,10}(一切).{0,10}(賠償).{0,10}(しない|しません)",
        "verdict": EdgeVerdict.REVIEW_HIGH,
        "risk_explanation": "SLA未達時の間接損害一切免責条項。契約の本旨に反する可能性",
        "check_points": ["SLA保証は契約の重要部分", "間接損害の全面免責は問題", "故意・重過失時は免責不可"],
        "legal_basis": "民法415条、消費者契約法8条"
    },
}

# =============================================================================
# 追加危険パターン（FALSE_OK=0達成用）
# =============================================================================

CRITICAL_DANGER_PATTERNS = {
    # 退職禁止（強制労働）
    "forced_labor_no_resignation": {
        "pattern": r"(退職|辞職|離職).{0,10}(認め|許可|できない|禁止|しない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "退職の自由を制限。労働基準法5条（強制労働の禁止）違反",
        "check_points": [
            "退職は労働者の基本的権利",
            "労働基準法5条違反",
            "憲法22条（職業選択の自由）にも抵触"
        ],
        "legal_basis": "労働基準法5条、憲法22条"
    },
    
    # 賠償予定（労働契約）
    "penalty_predetermined": {
        "pattern": r"(違約金|損害賠償|ペナルティ).{0,10}(として|を).{0,10}(\d+|○+|〇+).{0,5}(万円|円).{0,10}(支払|払う)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "損害賠償額の予定。労働基準法16条違反の可能性",
        "check_points": [
            "具体的金額の予定は違法となり得る",
            "労働基準法16条（賠償予定の禁止）",
            "消費者契約法9条（平均的損害）"
        ],
        "legal_basis": "労働基準法16条、消費者契約法9条"
    },
    
    # 一方的サービス停止
    "unilateral_service_stop": {
        "pattern": r"(当社|甲|弊社).{0,10}(判断|都合|理由).{0,10}(で|により).{0,10}(いつでも|事前.{0,5}なく).{0,10}(サービス|本サービス).{0,10}(停止|中止|終了)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "事業者の一方的判断による無条件サービス停止",
        "check_points": [
            "契約の本旨に反する一方的停止",
            "消費者契約法10条で無効",
            "債務不履行責任の問題"
        ],
        "legal_basis": "消費者契約法10条、民法415条"
    },
    
    # 一方的データ削除
    "unilateral_data_deletion": {
        "pattern": r"(データ|情報).{0,10}(いつでも|事前.{0,5}なく|当社.{0,5}判断).{0,10}(削除|消去|抹消)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "ユーザーデータの一方的削除権限",
        "check_points": [
            "ユーザーの財産権侵害",
            "個人情報保護法上の問題",
            "消費者契約法10条で無効"
        ],
        "legal_basis": "消費者契約法10条、個人情報保護法"
    },
    
    # 無制限規約変更
    "unlimited_tos_modification": {
        "pattern": r"(規約|約款|条件).{0,10}(当社|甲|弊社).{0,10}(判断|都合).{0,10}(で|により).{0,10}(いつでも|自由|随時).{0,10}(変更|改定)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "無制限の規約変更権限",
        "check_points": [
            "消費者契約法10条で無効",
            "民法548条の4の要件を満たさない",
            "変更通知・異議申立期間が必要"
        ],
        "legal_basis": "民法548条の4、消費者契約法10条"
    },
    
    # 無断第三者提供
    "unauthorized_third_party_sharing": {
        "pattern": r"(利用者|ユーザー|お客様).{0,5}(情報|データ).{0,10}(第三者|外部).{0,10}(提供|共有|開示).{0,10}(できる|する)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "同意なき個人情報の第三者提供",
        "check_points": [
            "個人情報保護法27条違反",
            "本人同意が必要",
            "オプトアウト規定の有無を確認"
        ],
        "legal_basis": "個人情報保護法27条"
    },
    
    # 敷金返還拒否
    "deposit_no_return": {
        "pattern": r"(敷金|保証金).{0,10}(一切|いかなる|理由.{0,5}問わず).{0,10}(返還|返却).{0,10}(しない|しません|できない)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "敷金の全額没収条項",
        "check_points": [
            "民法622条の2違反",
            "借地借家法の趣旨に反する",
            "消費者契約法10条で無効"
        ],
        "legal_basis": "民法622条の2、借地借家法、消費者契約法10条"
    },
    
    # 偽装請負
    "disguised_employment": {
        "pattern": r"(発注者|委託者|甲).{0,10}(指揮|命令|指示).{0,10}(に従い|に基づき|の下).{0,10}(業務|作業).{0,10}(遂行|行う)",
        "verdict": EdgeVerdict.NG_CRITICAL,
        "risk_explanation": "業務委託なのに指揮命令権を規定。偽装請負の典型",
        "check_points": [
            "職業安定法44条違反",
            "労働者派遣法違反",
            "実態は雇用関係の可能性"
        ],
        "legal_basis": "職業安定法44条、労働者派遣法"
    },
}


# =============================================================================
# メインエンジン
# =============================================================================

class EdgeCaseDetector:
    """エッジケース検出エンジン"""
    
    VERSION = "1.61.0"
    
    def __init__(self):
        self.pattern_groups = {
            "euphemistic_waiver": EUPHEMISTIC_WAIVER_PATTERNS,
            "implied_consent": IMPLIED_CONSENT_PATTERNS,
            "burden_shift": BURDEN_SHIFT_PATTERNS,
            "difficult_cancellation": DIFFICULT_CANCELLATION_PATTERNS,
            "vague_serious_cause": VAGUE_SERIOUS_CAUSE_PATTERNS,
            "conditional_waiver": CONDITIONAL_WAIVER_PATTERNS,
            "critical_danger": CRITICAL_DANGER_PATTERNS,
            # 公開判例対応パターン
            "case_law": CASE_LAW_PATTERNS,
            "labor_extended": LABOR_EXTENDED_PATTERNS,
            "disguised_employment": DISGUISED_EMPLOYMENT_PATTERNS,
            "subcontract_act": SUBCONTRACT_ACT_PATTERNS,
            "real_estate_extended": REAL_ESTATE_EXTENDED_PATTERNS,
            "franchise": FRANCHISE_PATTERNS,
            "it_saas_extended": IT_SAAS_EXTENDED_PATTERNS,
            # FALSE_OK解消用追加パターン
            "additional_false_ok": ADDITIONAL_PATTERNS_FOR_FALSE_OK,
            # 業界約款対応パターン
            "industry": INDUSTRY_PATTERNS,
        }
    
    def detect(self, clause_text: str) -> List[EdgeCaseResult]:
        """エッジケースを検出"""
        results = []
        
        for group_name, patterns in self.pattern_groups.items():
            for pattern_name, pattern_info in patterns.items():
                match = re.search(pattern_info["pattern"], clause_text)
                if match:
                    # exclude_if_contains チェック
                    if "exclude_if_contains" in pattern_info:
                        excluded = False
                        for exclude_word in pattern_info["exclude_if_contains"]:
                            if exclude_word in clause_text:
                                excluded = True
                                break
                        if excluded:
                            continue
                    
                    # validate関数がある場合は追加チェック
                    if "validate" in pattern_info:
                        if not pattern_info["validate"](match):
                            continue
                    
                    results.append(EdgeCaseResult(
                        verdict=pattern_info["verdict"],
                        trigger_name=f"{group_name}.{pattern_name}",
                        matched_text=match.group(0),
                        risk_explanation=pattern_info["risk_explanation"],
                        check_points=pattern_info["check_points"],
                        legal_basis=pattern_info["legal_basis"],
                        rewrite_suggestion=pattern_info.get("rewrite")
                    ))
        
        return results
    
    def get_statistics(self) -> Dict:
        """統計情報"""
        total = sum(len(patterns) for patterns in self.pattern_groups.values())
        by_group = {name: len(patterns) for name, patterns in self.pattern_groups.items()}
        
        return {
            "version": self.VERSION,
            "total_edge_patterns": total,
            "by_group": by_group,
            "categories": [
                "婉曲免責", "暗黙同意擬制", "証明責任転換",
                "実質的解約困難", "曖昧な重大事由", "条件付き全面免責"
            ]
        }


# エクスポート
edge_case_detector = EdgeCaseDetector()
