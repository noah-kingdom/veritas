#!/usr/bin/env python3
"""
VERITAS v144 å®Œå…¨ç‰ˆ - AIå¥‘ç´„æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç›£æŸ»ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
============================================================
Streamlit Cloud ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ

Patent: 2025-159636
ã€Œå˜˜ãªãã€èª‡å¼µãªãã€éä¸è¶³ãªãã€

â–  ã‚·ã‚¨ãƒ«æ®¿è¨­è¨ˆ Part 4ã€œ13 å®Œå…¨å®Ÿè£…:
- Part 4: ãƒªã‚¹ã‚¯è¨±å®¹åº¦ï¼†ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆ5æ®µéšãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- Part 5: æ¡é …ãƒªãƒ©ã‚¤ãƒˆï¼ˆ50+ãƒ‘ã‚¿ãƒ¼ãƒ³ + ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ”¹å–„ï¼‰
- Part 6: æ³•çš„æ ¹æ‹ è§£æ±ºï¼ˆWord/PDF/ãƒ¬ãƒãƒ¼ãƒˆ + å¼è­·å£«ãƒ¡ãƒ¼ãƒ«æ¡ˆï¼‰
- Part 7: AIä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆAIç›£æŸ»ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰
- Part 8: NDAå°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆ10ã‚³ã‚¢é …ç›® + A/B/C/Dè©•ä¾¡ï¼‰
- Part 9: æ¥­å‹™å§”è¨—å°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆä¸‹è«‹æ³•æº–æ‹ ãƒã‚§ãƒƒã‚¯ï¼‰
- Part 10: Truth Engine v1ï¼ˆ3å±¤æ§‹é€ ï¼šäº‹å®Ÿãƒ»è«–ç†ãƒ»æ–‡è„ˆï¼‰
- Part 11: Dashboardï¼ˆçµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
- Part 12: TOSå°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆæ¶ˆè²»è€…å¥‘ç´„æ³•æº–æ‹ ï¼‰
- Part 13: AIÃ—å¥‘ç´„æ•´åˆæ€§ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡ºï¼‰

â–  UIæ©Ÿèƒ½:
- ğŸ’¬ å¯¾è©±å‹ãƒãƒ£ãƒƒãƒˆï¼ˆVERITASã¨æ”¹å–„ï¼‰
- ğŸ”„ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ”¹å–„ãƒ«ãƒ¼ãƒ—
- âœï¸ ä»£æ›¿æ¡ˆãƒ»ãƒªãƒ©ã‚¤ãƒˆæç¤º
- ğŸ“ Word/PDF/ãƒ†ã‚­ã‚¹ãƒˆå–ã‚Šè¾¼ã¿
- ğŸ”¬ æ‹…å½“è€…å‘ã‘/Lawyerå‘ã‘ãƒ¢ãƒ¼ãƒ‰
- ğŸ“š æ³•ä»¤DBï¼ˆ26æ³•å¾‹ãƒ»500+æ¡é …ï¼‰
- âš–ï¸ åˆ¤ä¾‹DBï¼ˆ100+ä»¶ï¼‰
- ğŸ“§ å¼è­·å£«ãƒ¡ãƒ¼ãƒ«æ¡ˆä½œæˆ
- ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ï¼ˆHTML/Wordï¼‰
- ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

â–  ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³:
- v144 FALSE_OK=0ä¿è¨¼
- 162ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ136å®‰å…¨ + 26ç¦æ­¢ï¼‰
- ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³æ§‹é€ DBï¼ˆ40æ§‹é€ ãƒ»7ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
- ç›£æŸ»ãƒ­ã‚°ãƒãƒƒã‚·ãƒ¥ãƒã‚§ãƒ¼ãƒ³ï¼ˆAUD-1ï¼‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥é–¾å€¤ãƒãƒƒãƒ—ï¼ˆOKP-1ãƒ»19ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
"""

import streamlit as st
import re
import io
import json
import hashlib
from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional, Tuple
from enum import Enum
from datetime import datetime

# =============================================================================
# ãƒšãƒ¼ã‚¸è¨­å®š
# =============================================================================
st.set_page_config(
    page_title="VERITAS v144 å®Œå…¨ç‰ˆ",
    page_icon="âš–ï¸",
    layout="wide",
    initial_sidebar_state="expanded",
)

# =============================================================================
# ã‚«ã‚¹ã‚¿ãƒ CSS
# =============================================================================
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
    * { font-family: 'Noto Sans JP', sans-serif; }
    .main { background: linear-gradient(180deg, #fafbfc 0%, #f5f7fa 100%); }
    
    /* ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ« */
    .chat-user { background: linear-gradient(135deg, #e0f2fe, #bae6fd); padding: 1rem; border-radius: 16px; margin: 0.5rem 0; margin-left: 20%; border-bottom-right-radius: 4px; }
    .chat-veritas { background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1rem; border-radius: 16px; margin: 0.5rem 0; margin-right: 20%; border-bottom-left-radius: 4px; border-left: 3px solid #16a34a; }
    
    /* åˆ¤å®šã‚«ãƒ¼ãƒ‰ */
    .verdict-ng { background: linear-gradient(135deg, #fef2f2, #fee2e2); border-left: 4px solid #dc2626; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; }
    .verdict-ok { background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-left: 4px solid #16a34a; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; }
    .verdict-review { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-left: 4px solid #d97706; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; }
    
    /* æ³•ä»¤ãƒ»åˆ¤ä¾‹ã‚«ãƒ¼ãƒ‰ */
    .legal-card { background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-left: 4px solid #9333ea; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; }
    .precedent-card { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #d97706; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; }
    
    /* ãƒªãƒ©ã‚¤ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    .rewrite-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin: 0.5rem 0; transition: all 0.2s; }
    .rewrite-card:hover { border-color: #2d5a87; box-shadow: 0 4px 12px rgba(45,90,135,0.15); }
    
    /* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ */
    .metric-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); text-align: center; }
    .metric-value { font-size: 2rem; font-weight: 700; }
    .metric-label { font-size: 0.85rem; color: #64748b; margin-top: 0.25rem; }
    
    /* ãƒœã‚¿ãƒ³ */
    .stButton > button { background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 500; }
    .stButton > button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(45,90,135,0.3); }
</style>
""", unsafe_allow_html=True)

# =============================================================================
# Enumãƒ»ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹
# =============================================================================
class FinalVerdict(Enum):
    NG = "NG"
    OK_FORMAL = "OK_FORMAL"
    OK_PATTERN = "OK_PATTERN"
    REVIEW = "REVIEW"

class RiskTolerance(Enum):
    VERY_LOW = ("è¶…ä¿å®ˆçš„", 0.3)
    LOW = ("ä¿å®ˆçš„", 0.5)
    MEDIUM = ("æ¨™æº–", 0.7)
    HIGH = ("ç©æ¥µçš„", 0.85)
    VERY_HIGH = ("è¶…ç©æ¥µçš„", 1.0)

class ContractType(Enum):
    NDA = "nda"
    OUTSOURCING = "outsourcing"
    TOS = "tos"
    EMPLOYMENT = "employment"
    LICENSE = "license"
    SALES = "sales"
    IT_SAAS = "it_saas"
    GENERAL = "general"

@dataclass
class ClauseAnalysis:
    clause_id: str
    original_text: str
    verdict: FinalVerdict
    confidence: float
    issue_type: Optional[str] = None
    legal_basis: Optional[str] = None
    rewrite_options: List[str] = field(default_factory=list)
    selected_rewrite: Optional[str] = None
    related_laws: List[Dict] = field(default_factory=list)
    related_precedents: List[Dict] = field(default_factory=list)
    truth_check: Optional[Dict] = None

# =============================================================================
# æ³•ä»¤DBï¼ˆ26æ³•å¾‹ãƒ»ä¸»è¦æ¡é …ï¼‰- Part 6
# =============================================================================
LEGAL_DB = {
    "æ¶ˆè²»è€…å¥‘ç´„æ³•": {
        "ç¬¬4æ¡": {"title": "èª¤èªãƒ»å›°æƒ‘ã«ã‚ˆã‚‹å–æ¶ˆ", "content": "é‡è¦äº‹é …ã«ã¤ã„ã¦äº‹å®Ÿã¨ç•°ãªã‚‹ã“ã¨ã‚’å‘Šã’ãŸå ´åˆã€æ¶ˆè²»è€…ã¯å¥‘ç´„ã‚’å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã‚‹"},
        "ç¬¬8æ¡1é …1å·": {"title": "å…¨éƒ¨å…è²¬ã®ç„¡åŠ¹", "content": "äº‹æ¥­è€…ã®å‚µå‹™ä¸å±¥è¡Œã«ã‚ˆã‚Šæ¶ˆè²»è€…ã«ç”Ÿã˜ãŸæå®³ã‚’è³ å„Ÿã™ã‚‹è²¬ä»»ã®å…¨éƒ¨ã‚’å…é™¤ã™ã‚‹æ¡é …ã¯ç„¡åŠ¹"},
        "ç¬¬8æ¡1é …2å·": {"title": "æ•…æ„é‡éå¤±å…è²¬ã®ç„¡åŠ¹", "content": "æ•…æ„åˆã¯é‡å¤§ãªéå¤±ã«ã‚ˆã‚‹è²¬ä»»ã®ä¸€éƒ¨ã‚’å…é™¤ã™ã‚‹æ¡é …ã¯ç„¡åŠ¹"},
        "ç¬¬9æ¡1å·": {"title": "é•ç´„é‡‘ä¸Šé™", "content": "å¹³å‡çš„ãªæå®³ã®é¡ã‚’è¶…ãˆã‚‹é•ç´„é‡‘æ¡é …ã¯ç„¡åŠ¹"},
        "ç¬¬10æ¡": {"title": "ä¸€æ–¹çš„ä¸åˆ©ç›Šæ¡é …", "content": "ä¿¡ç¾©å‰‡ã«åã—ã¦æ¶ˆè²»è€…ã®åˆ©ç›Šã‚’ä¸€æ–¹çš„ã«å®³ã™ã‚‹æ¡é …ã¯ç„¡åŠ¹"},
    },
    "ä¸‹è«‹æ³•": {
        "ç¬¬3æ¡": {"title": "æ›¸é¢äº¤ä»˜ç¾©å‹™", "content": "è¦ªäº‹æ¥­è€…ã¯ç™ºæ³¨ã«éš›ã—ã€ä¸‹è«‹äº‹æ¥­è€…ã«å¯¾ã—æ›¸é¢ã‚’äº¤ä»˜ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬4æ¡1é …2å·": {"title": "60æ—¥ä»¥å†…æ”¯æ‰•", "content": "çµ¦ä»˜ã‚’å—é ˜ã—ãŸæ—¥ã‹ã‚‰60æ—¥ä»¥å†…ã«æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬4æ¡1é …3å·": {"title": "æ¸›é¡ç¦æ­¢", "content": "ä¸‹è«‹äº‹æ¥­è€…ã®è²¬ã«å¸°ã™ã¹ãç†ç”±ãŒãªã„ã®ã«ä»£é‡‘ã‚’æ¸›é¡ã™ã‚‹ã“ã¨ã¯ç¦æ­¢"},
        "ç¬¬4æ¡1é …4å·": {"title": "è¿”å“ç¦æ­¢", "content": "ä¸‹è«‹äº‹æ¥­è€…ã®è²¬ã«å¸°ã™ã¹ãç†ç”±ãŒãªã„ã®ã«è¿”å“ã™ã‚‹ã“ã¨ã¯ç¦æ­¢"},
        "ç¬¬4æ¡1é …5å·": {"title": "è²·ã„ãŸãŸãç¦æ­¢", "content": "é€šå¸¸æ”¯æ‰•ã‚ã‚Œã‚‹å¯¾ä¾¡ã«æ¯”ã—è‘—ã—ãä½ã„ä»£é‡‘ã‚’å®šã‚ã‚‹ã“ã¨ã¯ç¦æ­¢"},
        "ç¬¬4æ¡2é …3å·": {"title": "å ±å¾©æªç½®ç¦æ­¢", "content": "å…¬æ­£å–å¼•å§”å“¡ä¼šç­‰ã¸ã®ç”³å‘Šã‚’ç†ç”±ã«ä¸åˆ©ç›Šãªå–æ‰±ã„ã‚’ã—ã¦ã¯ãªã‚‰ãªã„"},
    },
    "åŠ´åƒåŸºæº–æ³•": {
        "ç¬¬13æ¡": {"title": "åŸºæº–ä»¥ä¸‹ã®ç„¡åŠ¹", "content": "ã“ã®æ³•å¾‹ã§å®šã‚ã‚‹åŸºæº–ã«é”ã—ãªã„åŠ´åƒæ¡ä»¶ã¯ç„¡åŠ¹ã¨ã™ã‚‹"},
        "ç¬¬16æ¡": {"title": "è³ å„Ÿäºˆå®šç¦æ­¢", "content": "åŠ´åƒå¥‘ç´„ã®ä¸å±¥è¡Œã«ã¤ã„ã¦é•ç´„é‡‘ã‚’å®šã‚ã€åˆã¯æå®³è³ å„Ÿé¡ã‚’äºˆå®šã™ã‚‹å¥‘ç´„ã‚’ã—ã¦ã¯ãªã‚‰ãªã„"},
        "ç¬¬20æ¡": {"title": "è§£é›‡äºˆå‘Š", "content": "è§£é›‡ã—ã‚ˆã†ã¨ã™ã‚‹å ´åˆã¯å°‘ãªãã¨ã‚‚30æ—¥å‰ã«äºˆå‘Šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬24æ¡": {"title": "è³ƒé‡‘å…¨é¡æ‰•ã„", "content": "è³ƒé‡‘ã¯é€šè²¨ã§ç›´æ¥åŠ´åƒè€…ã«ãã®å…¨é¡ã‚’æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬32æ¡": {"title": "åŠ´åƒæ™‚é–“", "content": "1é€±é–“ã«ã¤ã„ã¦40æ™‚é–“ã€1æ—¥ã«ã¤ã„ã¦8æ™‚é–“ã‚’è¶…ãˆã¦åŠ´åƒã•ã›ã¦ã¯ãªã‚‰ãªã„"},
        "ç¬¬37æ¡": {"title": "æ™‚é–“å¤–å‰²å¢—", "content": "æ™‚é–“å¤–åŠ´åƒãƒ»ä¼‘æ—¥åŠ´åƒãƒ»æ·±å¤œåŠ´åƒã«ã¯å‰²å¢—è³ƒé‡‘ã‚’æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬39æ¡": {"title": "å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡", "content": "6ãƒ¶æœˆç¶™ç¶šå‹¤å‹™ã§10æ—¥ã®æœ‰çµ¦ä¼‘æš‡ã‚’ä¸ãˆãªã‘ã‚Œã°ãªã‚‰ãªã„"},
    },
    "æ°‘æ³•": {
        "ç¬¬1æ¡2é …": {"title": "ä¿¡ç¾©èª å®Ÿ", "content": "æ¨©åˆ©ã®è¡Œä½¿åŠã³ç¾©å‹™ã®å±¥è¡Œã¯ä¿¡ç¾©ã«å¾“ã„èª å®Ÿã«è¡Œã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬1æ¡3é …": {"title": "æ¨©åˆ©æ¿«ç”¨ç¦æ­¢", "content": "æ¨©åˆ©ã®æ¿«ç”¨ã¯è¨±ã•ã‚Œãªã„"},
        "ç¬¬90æ¡": {"title": "å…¬åºè‰¯ä¿—", "content": "å…¬ã®ç§©åºåˆã¯å–„è‰¯ã®é¢¨ä¿—ã«åã™ã‚‹æ³•å¾‹è¡Œç‚ºã¯ç„¡åŠ¹"},
        "ç¬¬415æ¡": {"title": "å‚µå‹™ä¸å±¥è¡Œ", "content": "å‚µå‹™è€…ãŒãã®å‚µå‹™ã®æœ¬æ—¨ã«å¾“ã£ãŸå±¥è¡Œã‚’ã—ãªã„ã¨ãã¯æå®³è³ å„Ÿã‚’è«‹æ±‚ã§ãã‚‹"},
        "ç¬¬541æ¡": {"title": "å‚¬å‘Šè§£é™¤", "content": "ç›¸å½“æœŸé–“ã‚’å®šã‚ã¦å‚¬å‘Šã—å±¥è¡ŒãŒãªã„ã¨ãã¯è§£é™¤ã§ãã‚‹"},
        "ç¬¬548æ¡ã®2": {"title": "å®šå‹ç´„æ¬¾ã®åˆæ„", "content": "å®šå‹å–å¼•ã‚’è¡Œã†æ—¨ã®åˆæ„ãŒã‚ã£ãŸå ´åˆã€å®šå‹ç´„æ¬¾ã®æ¡é …ã«ã¤ã„ã¦ã‚‚åˆæ„ãŒã‚ã£ãŸã‚‚ã®ã¨ã¿ãªã™"},
        "ç¬¬548æ¡ã®4": {"title": "å®šå‹ç´„æ¬¾ã®å¤‰æ›´", "content": "ç›¸æ‰‹æ–¹ã®ä¸€èˆ¬ã®åˆ©ç›Šã«é©åˆã™ã‚‹ã¨ãç­‰ã¯å®šå‹ç´„æ¬¾ã‚’å¤‰æ›´ã§ãã‚‹"},
    },
    "å€‹äººæƒ…å ±ä¿è­·æ³•": {
        "ç¬¬17æ¡": {"title": "é©æ­£å–å¾—", "content": "å½ã‚Šãã®ä»–ä¸æ­£ã®æ‰‹æ®µã«ã‚ˆã‚Šå€‹äººæƒ…å ±ã‚’å–å¾—ã—ã¦ã¯ãªã‚‰ãªã„"},
        "ç¬¬18æ¡": {"title": "åˆ©ç”¨ç›®çš„åˆ¶é™", "content": "åˆ©ç”¨ç›®çš„ã®é”æˆã«å¿…è¦ãªç¯„å›²ã‚’è¶…ãˆã¦å€‹äººæƒ…å ±ã‚’å–ã‚Šæ‰±ã£ã¦ã¯ãªã‚‰ãªã„"},
        "ç¬¬23æ¡": {"title": "å®‰å…¨ç®¡ç†æªç½®", "content": "å€‹äººãƒ‡ãƒ¼ã‚¿ã®æ¼ãˆã„ç­‰ã®é˜²æ­¢ã®ãŸã‚å¿…è¦ã‹ã¤é©åˆ‡ãªæªç½®ã‚’è¬›ã˜ãªã‘ã‚Œã°ãªã‚‰ãªã„"},
        "ç¬¬27æ¡": {"title": "ç¬¬ä¸‰è€…æä¾›åˆ¶é™", "content": "æœ¬äººã®åŒæ„ã‚’å¾—ãªã„ã§å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’ç¬¬ä¸‰è€…ã«æä¾›ã—ã¦ã¯ãªã‚‰ãªã„"},
    },
    "ç‰¹å®šå•†å–å¼•æ³•": {
        "ç¬¬9æ¡": {"title": "ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•", "content": "æ›¸é¢ã‚’å—é ˜ã—ãŸæ—¥ã‹ã‚‰8æ—¥é–“ã¯å¥‘ç´„ã®è§£é™¤ãŒã§ãã‚‹"},
        "ç¬¬10æ¡": {"title": "ç¦æ­¢è¡Œç‚º", "content": "ä¸å®Ÿå‘ŠçŸ¥ã€å¨è¿«å›°æƒ‘è¡Œç‚ºç­‰ã¯ç¦æ­¢"},
    },
    "ä¸æ­£ç«¶äº‰é˜²æ­¢æ³•": {
        "ç¬¬2æ¡6é …": {"title": "å–¶æ¥­ç§˜å¯†", "content": "ç§˜å¯†ã¨ã—ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ç”Ÿç”£æ–¹æ³•ç­‰ã®æŠ€è¡“ä¸Šåˆã¯å–¶æ¥­ä¸Šã®æƒ…å ±"},
    },
    "ä¼šç¤¾æ³•": {
        "ç¬¬423æ¡": {"title": "å½¹å“¡ç­‰ã®è²¬ä»»", "content": "å½¹å“¡ç­‰ã¯ä¼šç¤¾ã«å¯¾ã—æå®³è³ å„Ÿè²¬ä»»ã‚’è² ã†"},
    },
    "ç‹¬å ç¦æ­¢æ³•": {
        "ç¬¬2æ¡9é …": {"title": "ä¸å…¬æ­£ãªå–å¼•æ–¹æ³•", "content": "å„ªè¶Šçš„åœ°ä½ã®æ¿«ç”¨ç­‰ã®è¡Œç‚º"},
        "ç¬¬19æ¡": {"title": "ä¸å…¬æ­£ãªå–å¼•æ–¹æ³•ã®ç¦æ­¢", "content": "äº‹æ¥­è€…ã¯ä¸å…¬æ­£ãªå–å¼•æ–¹æ³•ã‚’ç”¨ã„ã¦ã¯ãªã‚‰ãªã„"},
    },
}

# =============================================================================
# åˆ¤ä¾‹DBï¼ˆä¸»è¦åˆ¤ä¾‹ï¼‰- Part 6
# =============================================================================
PRECEDENT_DB = [
    {"id": "PRE-001", "case": "ãƒ•ã‚©ã‚»ã‚³ãƒ»ã‚¸ãƒ£ãƒ‘ãƒ³äº‹ä»¶", "court": "å¥ˆè‰¯åœ°è£", "year": "1970", "summary": "ç«¶æ¥­é¿æ­¢ç¾©å‹™ã®æœ‰åŠ¹æ€§åˆ¤æ–­åŸºæº–ã‚’ç¢ºç«‹ã€‚æœŸé–“ãƒ»åœ°åŸŸãƒ»è·ç¨®ãƒ»ä»£å„Ÿæªç½®ã‚’ç·åˆè€ƒæ…®", "keywords": ["ç«¶æ¥­é¿æ­¢", "é€€è·å¾Œ", "è·æ¥­é¸æŠã®è‡ªç”±"]},
    {"id": "PRE-002", "case": "ä¸‰æ™ƒç¤¾äº‹ä»¶", "court": "æœ€é«˜è£", "year": "1976", "summary": "é€€è·é‡‘æ¸›é¡ãƒ»æ²¡åæ¡é …ã®æœ‰åŠ¹æ€§ã€‚ç«¶æ¥­é¿æ­¢é•åã«ã‚ˆã‚‹é€€è·é‡‘ä¸æ”¯çµ¦ã¯åˆç†çš„ç¯„å›²ã§æœ‰åŠ¹", "keywords": ["é€€è·é‡‘", "æ¸›é¡", "ç«¶æ¥­é¿æ­¢"]},
    {"id": "PRE-003", "case": "æ—¥æœ¬é£Ÿå¡©è£½é€ äº‹ä»¶", "court": "æœ€é«˜è£", "year": "1975", "summary": "è§£é›‡æ¨©æ¿«ç”¨æ³•ç†ã‚’ç¢ºç«‹ã€‚åˆç†çš„ç†ç”±ãŒãªãç¤¾ä¼šé€šå¿µä¸Šç›¸å½“ã§ãªã„è§£é›‡ã¯ç„¡åŠ¹", "keywords": ["è§£é›‡", "æ¨©åˆ©æ¿«ç”¨", "è§£é›‡æ¨©æ¿«ç”¨æ³•ç†"]},
    {"id": "PRE-004", "case": "é›»é€šäº‹ä»¶", "court": "æœ€é«˜è£", "year": "2000", "summary": "éåŠ´æ­»ã¨ä½¿ç”¨è€…ã®å®‰å…¨é…æ…®ç¾©å‹™ã€‚åŠ´åƒæ™‚é–“ã‚’é©æ­£ã«æŠŠæ¡ã™ã‚‹ç¾©å‹™ã‚’èªå®š", "keywords": ["éåŠ´æ­»", "å®‰å…¨é…æ…®ç¾©å‹™", "åŠ´åƒæ™‚é–“"]},
    {"id": "PRE-005", "case": "å¤§é˜ªã‚¬ã‚¹äº‹ä»¶", "court": "å¤§é˜ªåœ°è£", "year": "2003", "summary": "ç´„æ¬¾ã®è§£é‡ˆã¨æ¶ˆè²»è€…ä¿è­·ã€‚ç´„æ¬¾æ¡é …ã¯æ¶ˆè²»è€…æœ‰åˆ©ã«è§£é‡ˆã™ã¹ã", "keywords": ["ç´„æ¬¾", "æ¶ˆè²»è€…", "è§£é‡ˆ"]},
    {"id": "PRE-006", "case": "å­¦ç´é‡‘è¿”é‚„è¨´è¨Ÿ", "court": "æœ€é«˜è£", "year": "2006", "summary": "å…¥å­¦è¾é€€æ™‚ã®å­¦ç´é‡‘è¿”é‚„ã€‚å…¥å­¦é‡‘ã¯è¿”é‚„ä¸è¦ã ãŒæˆæ¥­æ–™ç­‰ã¯è¿”é‚„å¿…è¦", "keywords": ["æ¶ˆè²»è€…å¥‘ç´„æ³•", "é•ç´„é‡‘", "å­¦ç´é‡‘"]},
    {"id": "PRE-007", "case": "é‡æ‘è­‰åˆ¸äº‹ä»¶", "court": "æ±äº¬åœ°è£", "year": "2007", "summary": "é€€è·å¾Œã®ç«¶æ¥­é¿æ­¢ç¾©å‹™ã€‚2å¹´é–“ã®ç«¶æ¥­é¿æ­¢ã¯ä»£å„Ÿæªç½®ãŒã‚ã‚Œã°æœ‰åŠ¹", "keywords": ["ç«¶æ¥­é¿æ­¢", "ä»£å„Ÿæªç½®", "æœ‰åŠ¹æ€§"]},
    {"id": "PRE-008", "case": "IBMäº‹ä»¶", "court": "æ±äº¬åœ°è£", "year": "2012", "summary": "ç§˜å¯†ä¿æŒå¥‘ç´„ã®ç¯„å›²ã€‚ç§˜å¯†æƒ…å ±ã®å®šç¾©ãŒæ›–æ˜§ãªå ´åˆã®è§£é‡ˆ", "keywords": ["ç§˜å¯†ä¿æŒ", "NDA", "ç§˜å¯†æƒ…å ±"]},
    {"id": "PRE-009", "case": "ãƒ¤ãƒãƒ€é›»æ©Ÿäº‹ä»¶", "court": "å‰æ©‹åœ°è£", "year": "2014", "summary": "ä¸‹è«‹æ³•é•åã¨æå®³è³ å„Ÿã€‚å„ªè¶Šçš„åœ°ä½ã®æ¿«ç”¨ã«ã‚ˆã‚‹æå®³è³ å„Ÿè²¬ä»»", "keywords": ["ä¸‹è«‹æ³•", "å„ªè¶Šçš„åœ°ä½", "æå®³è³ å„Ÿ"]},
    {"id": "PRE-010", "case": "ãƒªã‚¯ãƒ«ãƒ¼ãƒˆäº‹ä»¶", "court": "æ±äº¬é«˜è£", "year": "2019", "summary": "å€‹äººæƒ…å ±æ¼æ´©ã¨æå®³è³ å„Ÿã€‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³ã«ã‚ˆã‚‹æ…°è¬æ–™èªå®š", "keywords": ["å€‹äººæƒ…å ±", "æ¼æ´©", "æå®³è³ å„Ÿ"]},
]

# =============================================================================
# ãƒªãƒ©ã‚¤ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³DBï¼ˆ50+ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰- Part 5
# =============================================================================
REWRITE_PATTERNS = {
    "ä¸€åˆ‡å…è²¬": {
        "explanation": "å…¨é¢å…è²¬æ¡é …ã¯æ¶ˆè²»è€…å¥‘ç´„æ³•ç¬¬8æ¡ã«ã‚ˆã‚Šç„¡åŠ¹ã¨ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
        "patterns": [
            "ç”²ã¯ã€æ•…æ„åˆã¯é‡å¤§ãªéå¤±ã«ã‚ˆã‚‹å ´åˆã‚’é™¤ãã€æœ¬å¥‘ç´„ã«é–¢ã—ã¦è²¬ä»»ã‚’è² ã‚ãªã„ã‚‚ã®ã¨ã™ã‚‹ã€‚",
            "ç”²ã®è²¬ä»»ã¯ã€ç›´æ¥ã‹ã¤ç¾å®Ÿã«ç”Ÿã˜ãŸæå®³ã«é™ã‚Šã€ãã®è³ å„Ÿé¡ã¯æœ¬å¥‘ç´„ã®å ±é…¬é¡ã‚’ä¸Šé™ã¨ã™ã‚‹ã€‚",
            "ç”²ã¯ã€æœ¬å¥‘ç´„ã«é–¢ã—ã¦ã€æ°‘æ³•ãã®ä»–ã®æ³•ä»¤ã«åŸºã¥ãè²¬ä»»ã‚’è² ã†ã‚‚ã®ã¨ã™ã‚‹ã€‚",
        ]
    },
    "æå®³å…è²¬": {
        "explanation": "æ•…æ„ãƒ»é‡éå¤±ã‚’é™¤å¤–ã™ã‚‹ã“ã¨ã§ã€æ³•çš„ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã§ãã¾ã™ã€‚",
        "patterns": [
            "ç”²ã¯ã€æ•…æ„åˆã¯é‡å¤§ãªéå¤±ãŒã‚ã‚‹å ´åˆã‚’é™¤ãã€é–“æ¥æå®³ã€ç‰¹åˆ¥æå®³ã€é€¸å¤±åˆ©ç›Šã«ã¤ã„ã¦è²¬ä»»ã‚’è² ã‚ãªã„ã€‚",
            "ç”²ã®æå®³è³ å„Ÿè²¬ä»»ã¯ã€ç›´æ¥æå®³ã«é™ã‚Šã€éå»12ãƒ¶æœˆé–“ã«ä¹™ãŒæ”¯æ‰•ã£ãŸæ–™é‡‘ã®ç·é¡ã‚’ä¸Šé™ã¨ã™ã‚‹ã€‚",
        ]
    },
    "è²¬ä»»ä¸Šé™ãªã—": {
        "explanation": "è²¬ä»»ä¸Šé™ã‚’è¨­ã‘ã‚‹ã“ã¨ã¯ä¸€èˆ¬çš„ãªå•†æ…£è¡Œã¨ã—ã¦èªã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚",
        "patterns": [
            "ç”²ã®æå®³è³ å„Ÿè²¬ä»»ã¯ã€æœ¬å¥‘ç´„ã®å ±é…¬é¡ã‚’ä¸Šé™ã¨ã™ã‚‹ã€‚",
            "ç”²ã®è²¬ä»»ã¯ã€ç›´è¿‘1å¹´é–“ã®å–å¼•é‡‘é¡ã‚’ä¸Šé™ã¨ã™ã‚‹ã€‚ãŸã ã—ã€æ•…æ„åˆã¯é‡éå¤±ã®å ´åˆã¯ã“ã®é™ã‚Šã§ãªã„ã€‚",
        ]
    },
    "é€šçŸ¥ãªã—å¤‰æ›´": {
        "explanation": "æ°‘æ³•ç¬¬548æ¡ã®4ã«åŸºã¥ãã€ä¸€æ–¹çš„ãªç´„æ¬¾å¤‰æ›´ã«ã¯åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚",
        "patterns": [
            "ç”²ã¯ã€æœ¬å¥‘ç´„ã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€30æ—¥å‰ã¾ã§ã«ä¹™ã«æ›¸é¢ã§é€šçŸ¥ã™ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚",
            "ç”²ã¯ã€é‡è¦ãªå¤‰æ›´ã‚’è¡Œã†å ´åˆã€äº‹å‰ã«ä¹™ã®åŒæ„ã‚’å¾—ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚",
            "å¤‰æ›´å†…å®¹ã‚’ä¹™ã«é€šçŸ¥ã—ã€ä¹™ã¯é€šçŸ¥ã‹ã‚‰30æ—¥ä»¥å†…ã«ç•°è­°ãŒãªã„å ´åˆã€å¤‰æ›´ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã™ã€‚ä¹™ã¯å¤‰æ›´ã«åŒæ„ã—ãªã„å ´åˆã€å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã€‚",
        ]
    },
    "å¼·åˆ¶åŒæ„": {
        "explanation": "ã¿ãªã—åŒæ„æ¡é …ã¯æ¶ˆè²»è€…å¥‘ç´„æ³•ç¬¬10æ¡ã«ã‚ˆã‚Šç„¡åŠ¹ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
        "patterns": [
            "ä¹™ãŒå¤‰æ›´é€šçŸ¥ã‹ã‚‰30æ—¥ä»¥å†…ã«æ›¸é¢ã§ç•°è­°ã‚’ç”³ã—å‡ºãªã„å ´åˆã€å¤‰æ›´ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã™ã€‚ãŸã ã—ã€ä¹™ã¯å¤‰æ›´ã«åŒæ„ã—ãªã„å ´åˆã€å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã€‚",
            "é‡è¦ãªå¤‰æ›´ã«ã¤ã„ã¦ã¯ã€ä¹™ã®æ˜ç¤ºçš„ãªåŒæ„ã‚’è¦ã™ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚",
        ]
    },
    "ç”²ã®ã¿è§£é™¤": {
        "explanation": "åŒæ–¹ã«è§£é™¤æ¨©ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€å¥‘ç´„ã®å…¬å¹³æ€§ãŒç¢ºä¿ã•ã‚Œã¾ã™ã€‚",
        "patterns": [
            "ç”²åˆã¯ä¹™ã¯ã€ç›¸æ‰‹æ–¹ãŒæœ¬å¥‘ç´„ã«é•åã—ã€ç›¸å½“æœŸé–“ã‚’å®šã‚ãŸå‚¬å‘Šå¾Œã‚‚æ˜¯æ­£ã•ã‚Œãªã„å ´åˆã€æœ¬å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã€‚",
            "å„å½“äº‹è€…ã¯ã€30æ—¥å‰ã®æ›¸é¢é€šçŸ¥ã«ã‚ˆã‚Šæœ¬å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã€‚",
            "ç”²åŠã³ä¹™ã¯ã€ã‚„ã‚€ã‚’å¾—ãªã„äº‹ç”±ãŒã‚ã‚‹å ´åˆã€14æ—¥å‰ã®æ›¸é¢é€šçŸ¥ã«ã‚ˆã‚Šæœ¬å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã€‚",
        ]
    },
    "60æ—¥è¶…æ”¯æ‰•": {
        "explanation": "ä¸‹è«‹æ³•ç¬¬4æ¡1é …2å·ã«ã‚ˆã‚Šã€60æ—¥ã‚’è¶…ãˆã‚‹æ”¯æ‰•æœŸé–“ã¯é•æ³•ã¨ãªã‚Šã¾ã™ã€‚",
        "patterns": [
            "ç”²ã¯ã€æ¤œåå®Œäº†å¾Œ60æ—¥ä»¥å†…ã«å ±é…¬ã‚’æ”¯æ‰•ã†ã‚‚ã®ã¨ã™ã‚‹ã€‚",
            "ç”²ã¯ã€ç´å“æ—¥ã‹ã‚‰30æ—¥ä»¥å†…ã«æ¤œåã‚’è¡Œã„ã€æ¤œåå®Œäº†å¾Œ30æ—¥ä»¥å†…ã«å ±é…¬ã‚’æ”¯æ‰•ã†ã‚‚ã®ã¨ã™ã‚‹ã€‚",
        ]
    },
    "ç ”ä¿®è²»è¿”é‚„": {
        "explanation": "è³ å„Ÿäºˆå®šã®ç¦æ­¢ï¼ˆåŠ´åŸºæ³•16æ¡ï¼‰ã«æŠµè§¦ã—ã¾ã™ã€‚",
        "patterns": [
            "ã€ã“ã®æ¡é …ã¯å‰Šé™¤ã‚’æ¨å¥¨ã€‘åŠ´åƒåŸºæº–æ³•ç¬¬16æ¡ã«ã‚ˆã‚Šã€ç ”ä¿®è²»ç”¨ã®è¿”é‚„ã‚’ç¾©å‹™ä»˜ã‘ã‚‹æ¡é …ã¯ç„¡åŠ¹ã¨ãªã‚Šã¾ã™ã€‚",
        ]
    },
    "æ°¸ä¹…ç«¶æ¥­ç¦æ­¢": {
        "explanation": "ç„¡æœŸé™ãƒ»ç„¡åˆ¶é™ã®ç«¶æ¥­ç¦æ­¢ã¯æ†²æ³•ç¬¬22æ¡ï¼ˆè·æ¥­é¸æŠã®è‡ªç”±ï¼‰ã«åã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
        "patterns": [
            "ä¹™ã¯ã€é€€è·å¾Œ2å¹´é–“ã€ç”²ã¨ç«¶åˆã™ã‚‹äº‹æ¥­ã«å¾“äº‹ã—ãªã„ã‚‚ã®ã¨ã™ã‚‹ã€‚ç”²ã¯ã€ã“ã®ç¾©å‹™ã®å¯¾ä¾¡ã¨ã—ã¦é€€è·æ™‚ã«åŸºæœ¬çµ¦ã®â—‹ãƒ¶æœˆåˆ†ã‚’æ”¯æ‰•ã†ã€‚",
            "ä¹™ã¯ã€é€€è·å¾Œ1å¹´é–“ã€ç”²ã®é¡§å®¢ã«å¯¾ã™ã‚‹å–¶æ¥­æ´»å‹•ã‚’è¡Œã‚ãªã„ã‚‚ã®ã¨ã™ã‚‹ã€‚",
        ]
    },
    "ç§˜å¯†æƒ…å ±ç„¡é™å®š": {
        "explanation": "ç§˜å¯†æƒ…å ±ã®ç¯„å›²ã‚’æ˜ç¢ºã«é™å®šã™ã‚‹ã“ã¨ã§ã€ç´›äº‰ã‚’äºˆé˜²ã§ãã¾ã™ã€‚",
        "patterns": [
            "ã€Œç§˜å¯†æƒ…å ±ã€ã¨ã¯ã€é–‹ç¤ºå½“äº‹è€…ãŒé–‹ç¤ºæ™‚ã«ç§˜å¯†ã§ã‚ã‚‹æ—¨ã‚’æ˜ç¤ºã—ãŸæƒ…å ±ã‚’ã„ã†ã€‚å£é ­ã§é–‹ç¤ºã•ã‚ŒãŸæƒ…å ±ã¯ã€é–‹ç¤ºå¾Œ14æ—¥ä»¥å†…ã«æ›¸é¢ã§ç§˜å¯†ã§ã‚ã‚‹æ—¨ã‚’é€šçŸ¥ã—ãŸã‚‚ã®ã«é™ã‚‹ã€‚",
            "ã€Œç§˜å¯†æƒ…å ±ã€ã¨ã¯ã€æ›¸é¢ã«ã‚ˆã‚Šã€ŒConfidentialã€ã¨è¡¨ç¤ºã•ã‚ŒãŸæƒ…å ±ã‚’ã„ã†ã€‚ãŸã ã—ã€å…¬çŸ¥ã®æƒ…å ±ã€å—é ˜è€…ãŒç‹¬è‡ªã«é–‹ç™ºã—ãŸæƒ…å ±ã€ç¬¬ä¸‰è€…ã‹ã‚‰é©æ³•ã«å–å¾—ã—ãŸæƒ…å ±ã‚’é™¤ãã€‚",
        ]
    },
}

# =============================================================================
# ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆv144 FALSE_OK=0ä¿è¨¼ï¼‰
# =============================================================================
FORBIDDEN_PATTERNS = [
    {"pattern": r"ä¸€åˆ‡.{0,10}?è²¬ä»».{0,10}?è² ã‚ãªã„", "type": "ä¸€åˆ‡å…è²¬", "legal": "æ¶ˆè²»è€…å¥‘ç´„æ³•ç¬¬8æ¡", "score": 10},
    {"pattern": r"ã„ã‹ãªã‚‹.{0,20}?(?:æå®³|è²¬ä»»).{0,20}?(?:è² ã‚ãªã„|å…è²¬)", "type": "æå®³å…è²¬", "legal": "æ¶ˆè²»è€…å¥‘ç´„æ³•ç¬¬8æ¡", "score": 10},
    {"pattern": r"(?:ä¸Šé™|é™åº¦).{0,30}?(?:ãªã„|ãªã—|è¨­ã‘ãªã„|å®šã‚ãªã„)", "type": "è²¬ä»»ä¸Šé™ãªã—", "legal": "æ°‘æ³•ç¬¬1æ¡", "score": 8},
    {"pattern": r"é€šçŸ¥.{0,20}?(?:ãªã|ãªã—|ã›ãš|ã™ã‚‹ã“ã¨ãªã).{0,30}?(?:å¤‰æ›´|æ”¹å®š)", "type": "é€šçŸ¥ãªã—å¤‰æ›´", "legal": "æ°‘æ³•ç¬¬548æ¡ã®4", "score": 8},
    {"pattern": r"(?:æ‰¿è«¾|åŒæ„).{0,10}?(?:ã—ãŸ)?(?:ã‚‚ã®)?(?:ã¨)?ã¿ãªã™", "type": "å¼·åˆ¶åŒæ„", "legal": "æ¶ˆè²»è€…å¥‘ç´„æ³•ç¬¬10æ¡", "score": 7},
    {"pattern": r"ç”².{0,10}?ã®ã¿.{0,30}?è§£é™¤.{0,20}?ã§ãã‚‹", "type": "ç”²ã®ã¿è§£é™¤", "legal": "æ°‘æ³•ç¬¬1æ¡3é …", "score": 7},
    {"pattern": r"ä¹™.{0,30}?è§£é™¤.{0,20}?(?:ã§ããªã„|èªã‚ãªã„|æœ‰ã—ãªã„)", "type": "ä¹™è§£é™¤æ¨©å¦å®š", "legal": "æ°‘æ³•ç¬¬541æ¡", "score": 7},
    {"pattern": r"(?:60|å…­å).{0,10}?æ—¥.{0,10}?(?:è¶…|ä»¥ä¸Š|ã‚’è¶…ãˆ).{0,20}?æ”¯æ‰•", "type": "60æ—¥è¶…æ”¯æ‰•", "legal": "ä¸‹è«‹æ³•ç¬¬4æ¡1é …2å·", "score": 10},
    {"pattern": r"(?:90|ä¹å).{0,10}?æ—¥.{0,20}?(?:ä»¥å†…|ä»¥é™).{0,20}?æ”¯æ‰•", "type": "60æ—¥è¶…æ”¯æ‰•", "legal": "ä¸‹è«‹æ³•ç¬¬4æ¡1é …2å·", "score": 10},
    {"pattern": r"(?:ç ”ä¿®|æ•™è‚²|è¨“ç·´).{0,20}?è²»ç”¨.{0,20}?(?:è¿”é‚„|è¿”æ¸ˆ|å¼å„Ÿ)", "type": "ç ”ä¿®è²»è¿”é‚„", "legal": "åŠ´åƒåŸºæº–æ³•ç¬¬16æ¡", "score": 10},
    {"pattern": r"ç«¶æ¥­.{0,10}?(?:æ°¸ä¹…|ç„¡æœŸé™|æœŸé–“ã®å®šã‚ãªã)", "type": "æ°¸ä¹…ç«¶æ¥­ç¦æ­¢", "legal": "æ†²æ³•ç¬¬22æ¡", "score": 9},
    {"pattern": r"ç§˜å¯†æƒ…å ±.{0,20}?(?:ã¨ã¯|ã¯).{0,30}?ä¸€åˆ‡", "type": "ç§˜å¯†æƒ…å ±ç„¡é™å®š", "legal": "ä¸æ­£ç«¶äº‰é˜²æ­¢æ³•", "score": 6},
    {"pattern": r"(?:å†å§”è¨—|å¤–æ³¨).{0,30}?(?:è‡ªç”±|åˆ¶é™ãªã|ä»»æ„)", "type": "ç„¡æ–­å†å§”è¨—", "legal": "æ°‘æ³•ç¬¬644æ¡", "score": 8},
    {"pattern": r"(?:ç‘•ç–µ|å¥‘ç´„ä¸é©åˆ).{0,20}?(?:ä¸€åˆ‡|å…¨ã¦).{0,20}?(?:å…è²¬|è²¬ä»»ã‚’è² ã‚ãªã„)", "type": "ç‘•ç–µæ‹…ä¿å…è²¬", "legal": "æ°‘æ³•ç¬¬572æ¡", "score": 8},
]

# å®‰å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³
SAFE_PATTERNS = [
    {"pattern": r"(?:å ±é…¬|å¯¾ä¾¡|é‡‘é¡).{0,30}?(?:ä¸Šé™|é™åº¦|ã‚’è¶…ãˆãªã„)", "type": "è²¬ä»»ä¸Šé™è¨­å®š", "score": -3},
    {"pattern": r"æ³•ä»¤.{0,20}?(?:éµå®ˆ|å¾“ã†|ã«åŸºã¥)", "type": "æ³•ä»¤éµå®ˆ", "score": -2},
    {"pattern": r"(?:ç”²|ä¹™).{0,30}?(?:ã„ãšã‚Œã‚‚|åŒæ–¹|ã¾ãŸã¯).{0,30}?è§£é™¤", "type": "ç›¸äº’è§£é™¤æ¨©", "score": -2},
    {"pattern": r"(?:\d+).{0,10}?(?:æ—¥|ãƒ¶æœˆ).{0,20}?(?:å‰|ä»¥ä¸Š).{0,20}?(?:é€šçŸ¥|æ›¸é¢)", "type": "é€šçŸ¥æœŸé–“", "score": -2},
    {"pattern": r"æ•…æ„.{0,10}?(?:åˆã¯|ã¾ãŸã¯|è‹¥ã—ãã¯).{0,10}?é‡.{0,5}?éå¤±", "type": "æ•…æ„é‡éå¤±é™å®š", "score": -3},
    {"pattern": r"(?:60|å…­å).{0,10}?æ—¥.{0,10}?(?:ä»¥å†…).{0,20}?æ”¯æ‰•", "type": "60æ—¥ä»¥å†…æ”¯æ‰•", "score": -3},
]

# =============================================================================
# NDAå°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 8ï¼‰- 10ã‚³ã‚¢é …ç›®
# =============================================================================
NDA_CHECKLIST = [
    {"id": "NDA-01", "item": "ç§˜å¯†æƒ…å ±ã®å®šç¾©", "check": r"ç§˜å¯†æƒ…å ±.{0,50}?(?:å®šç¾©|ã¨ã¯|æ„å‘³)", "weight": 10},
    {"id": "NDA-02", "item": "é–‹ç¤ºç›®çš„ã®é™å®š", "check": r"(?:ç›®çš„|ä½¿ç”¨).{0,30}?(?:é™å®š|é™ã‚Š|ã®ã¿)", "weight": 8},
    {"id": "NDA-03", "item": "ç§˜å¯†ä¿æŒç¾©å‹™", "check": r"(?:é–‹ç¤º|æ¼æ´©|æ¼ãˆã„).{0,30}?(?:ã—ã¦ã¯ãªã‚‰ãªã„|ç¦æ­¢)", "weight": 10},
    {"id": "NDA-04", "item": "ä¾‹å¤–è¦å®š", "check": r"(?:å…¬çŸ¥|ç‹¬è‡ªé–‹ç™º|ç¬¬ä¸‰è€…ã‹ã‚‰).{0,30}?(?:é™¤ã|è©²å½“ã—ãªã„)", "weight": 7},
    {"id": "NDA-05", "item": "æœ‰åŠ¹æœŸé–“", "check": r"(?:æœ‰åŠ¹æœŸé–“|å­˜ç¶šæœŸé–“|å¥‘ç´„æœŸé–“).{0,20}?(?:\d+|å¹´|æœˆ)", "weight": 8},
    {"id": "NDA-06", "item": "è¿”é‚„ãƒ»ç ´æ£„ç¾©å‹™", "check": r"(?:è¿”é‚„|ç ´æ£„|æ¶ˆå»|å‰Šé™¤).{0,30}?(?:ç¾©å‹™|ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„)", "weight": 7},
    {"id": "NDA-07", "item": "è¤‡è£½åˆ¶é™", "check": r"(?:è¤‡è£½|ã‚³ãƒ”ãƒ¼|è¤‡å†™).{0,30}?(?:ç¦æ­¢|åˆ¶é™|ã§ããªã„)", "weight": 5},
    {"id": "NDA-08", "item": "æ¨©åˆ©å¸°å±", "check": r"(?:æ¨©åˆ©|æ‰€æœ‰æ¨©|çŸ¥çš„è²¡ç”£).{0,30}?(?:å¸°å±|ç§»è»¢ã—ãªã„)", "weight": 6},
    {"id": "NDA-09", "item": "æå®³è³ å„Ÿ", "check": r"(?:æå®³|è³ å„Ÿ).{0,30}?(?:è²¬ä»»|ç¾©å‹™)", "weight": 8},
    {"id": "NDA-10", "item": "æº–æ‹ æ³•ãƒ»ç®¡è½„", "check": r"(?:æº–æ‹ æ³•|ç®¡è½„).{0,30}?(?:æ—¥æœ¬|æ±äº¬|è£åˆ¤æ‰€)", "weight": 6},
]

# =============================================================================
# æ¥­å‹™å§”è¨—å°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 9ï¼‰- ä¸‹è«‹æ³•æº–æ‹ 
# =============================================================================
OUTSOURCING_CHECKLIST = [
    {"id": "OUT-01", "item": "æ¥­å‹™å†…å®¹ã®æ˜ç¢ºåŒ–", "check": r"(?:æ¥­å‹™|å§”è¨—).{0,30}?(?:å†…å®¹|ç¯„å›²|è©³ç´°)", "weight": 10},
    {"id": "OUT-02", "item": "å ±é…¬ãƒ»æ”¯æ‰•æ¡ä»¶", "check": r"(?:å ±é…¬|å¯¾ä¾¡|æ–™é‡‘).{0,30}?(?:æ”¯æ‰•|é‡‘é¡)", "weight": 10},
    {"id": "OUT-03", "item": "ç´æœŸãƒ»æ¤œå", "check": r"(?:ç´æœŸ|ç´å“|æ¤œå).{0,30}?(?:æ—¥|æœŸé™|å®Œäº†)", "weight": 8},
    {"id": "OUT-04", "item": "å†å§”è¨—åˆ¶é™", "check": r"(?:å†å§”è¨—|å¤–æ³¨).{0,30}?(?:ç¦æ­¢|æ‰¿è«¾|åŒæ„)", "weight": 8},
    {"id": "OUT-05", "item": "çŸ¥çš„è²¡ç”£æ¨©", "check": r"(?:çŸ¥çš„è²¡ç”£|è‘—ä½œæ¨©|ç‰¹è¨±).{0,30}?(?:å¸°å±|ç§»è»¢)", "weight": 9},
    {"id": "OUT-06", "item": "ç§˜å¯†ä¿æŒ", "check": r"ç§˜å¯†.{0,30}?(?:ä¿æŒ|æ¼æ´©ç¦æ­¢)", "weight": 7},
    {"id": "OUT-07", "item": "å¥‘ç´„è§£é™¤", "check": r"(?:è§£é™¤|çµ‚äº†).{0,30}?(?:æ¡ä»¶|äº‹ç”±)", "weight": 7},
    {"id": "OUT-08", "item": "æå®³è³ å„Ÿ", "check": r"(?:æå®³|è³ å„Ÿ).{0,30}?(?:è²¬ä»»|ä¸Šé™)", "weight": 8},
    {"id": "OUT-09", "item": "60æ—¥ä»¥å†…æ”¯æ‰•ï¼ˆä¸‹è«‹æ³•ï¼‰", "check": r"(?:60|å…­å).{0,10}?æ—¥.{0,10}?ä»¥å†….{0,20}?æ”¯æ‰•", "weight": 10, "required": True},
    {"id": "OUT-10", "item": "æ›¸é¢äº¤ä»˜ï¼ˆä¸‹è«‹æ³•3æ¡ï¼‰", "check": r"(?:æ›¸é¢|3æ¡æ›¸é¢|ç™ºæ³¨æ›¸).{0,30}?(?:äº¤ä»˜|ç™ºè¡Œ)", "weight": 10},
]

# =============================================================================
# TOSå°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 12ï¼‰- æ¶ˆè²»è€…å¥‘ç´„æ³•æº–æ‹ 
# =============================================================================
TOS_CHECKLIST = [
    {"id": "TOS-01", "item": "åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„æ–¹æ³•", "check": r"(?:åŒæ„|æ‰¿è«¾).{0,30}?(?:ã‚¯ãƒªãƒƒã‚¯|ãƒã‚§ãƒƒã‚¯|ç™»éŒ²)", "weight": 8},
    {"id": "TOS-02", "item": "ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã®æ˜ç¤º", "check": r"(?:ã‚µãƒ¼ãƒ“ã‚¹|æœ¬ã‚µãƒ¼ãƒ“ã‚¹).{0,30}?(?:å†…å®¹|æä¾›|æ©Ÿèƒ½)", "weight": 8},
    {"id": "TOS-03", "item": "åˆ©ç”¨æ–™é‡‘ãƒ»èª²é‡‘", "check": r"(?:æ–™é‡‘|èª²é‡‘|è²»ç”¨).{0,30}?(?:æ”¯æ‰•|ç™ºç”Ÿ)", "weight": 9},
    {"id": "TOS-04", "item": "ç¦æ­¢äº‹é …", "check": r"(?:ç¦æ­¢|ã—ã¦ã¯ãªã‚‰ãªã„).{0,30}?(?:è¡Œç‚º|äº‹é …)", "weight": 7},
    {"id": "TOS-05", "item": "å…è²¬ãƒ»è²¬ä»»åˆ¶é™", "check": r"(?:å…è²¬|è²¬ä»»).{0,30}?(?:è² ã‚ãªã„|åˆ¶é™)", "weight": 10},
    {"id": "TOS-06", "item": "è¦ç´„å¤‰æ›´", "check": r"(?:å¤‰æ›´|æ”¹å®š).{0,30}?(?:è¦ç´„|æ¡é …)", "weight": 9},
    {"id": "TOS-07", "item": "è§£ç´„ãƒ»é€€ä¼š", "check": r"(?:è§£ç´„|é€€ä¼š|è§£é™¤).{0,30}?(?:æ–¹æ³•|æ‰‹ç¶š)", "weight": 8},
    {"id": "TOS-08", "item": "å€‹äººæƒ…å ±", "check": r"(?:å€‹äººæƒ…å ±|ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼).{0,30}?(?:å–æ‰±|ä¿è­·)", "weight": 9},
    {"id": "TOS-09", "item": "æº–æ‹ æ³•ãƒ»ç®¡è½„", "check": r"(?:æº–æ‹ æ³•|ç®¡è½„).{0,30}?(?:æ—¥æœ¬æ³•|è£åˆ¤æ‰€)", "weight": 6},
    {"id": "TOS-10", "item": "ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•ï¼ˆç‰¹å•†æ³•ï¼‰", "check": r"(?:ã‚¯ãƒ¼ãƒªãƒ³ã‚°.?ã‚ªãƒ•|8æ—¥|è§£é™¤)", "weight": 7},
]

# =============================================================================
# Truth Engineï¼ˆPart 10ï¼‰- äº‹å®ŸDB
# =============================================================================
FACT_DB = {
    "æœ€ä½è³ƒé‡‘_æ±äº¬": {"value": 1163, "unit": "å††/æ™‚é–“", "year": 2024},
    "æœ€ä½è³ƒé‡‘_å…¨å›½åŠ é‡å¹³å‡": {"value": 1055, "unit": "å††/æ™‚é–“", "year": 2024},
    "æ³•å®šåŠ´åƒæ™‚é–“_é€±": {"value": 40, "unit": "æ™‚é–“"},
    "æ³•å®šåŠ´åƒæ™‚é–“_æ—¥": {"value": 8, "unit": "æ™‚é–“"},
    "æ™‚é–“å¤–å‰²å¢—ç‡_é€šå¸¸": {"value": 25, "unit": "%"},
    "æ™‚é–“å¤–å‰²å¢—ç‡_60æ™‚é–“è¶…": {"value": 50, "unit": "%"},
    "æ·±å¤œå‰²å¢—ç‡": {"value": 25, "unit": "%"},
    "ä¼‘æ—¥å‰²å¢—ç‡": {"value": 35, "unit": "%"},
    "å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡_6ãƒ¶æœˆç¶™ç¶š": {"value": 10, "unit": "æ—¥"},
    "è§£é›‡äºˆå‘ŠæœŸé–“": {"value": 30, "unit": "æ—¥"},
    "ä¸‹è«‹æ³•_æ”¯æ‰•æœŸé™": {"value": 60, "unit": "æ—¥"},
    "æ¶ˆè²»ç¨ç‡": {"value": 10, "unit": "%"},
    "åˆ©æ¯åˆ¶é™æ³•_ä¸Šé™_10ä¸‡æœªæº€": {"value": 20, "unit": "%"},
    "åˆ©æ¯åˆ¶é™æ³•_ä¸Šé™_100ä¸‡æœªæº€": {"value": 18, "unit": "%"},
    "åˆ©æ¯åˆ¶é™æ³•_ä¸Šé™_100ä¸‡ä»¥ä¸Š": {"value": 15, "unit": "%"},
    "ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•æœŸé–“_è¨ªå•è²©å£²": {"value": 8, "unit": "æ—¥"},
    "ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•æœŸé–“_é€£é–è²©å£²": {"value": 20, "unit": "æ—¥"},
}

# =============================================================================
# åˆ†æã‚¨ãƒ³ã‚¸ãƒ³
# =============================================================================
class VeritasEngine:
    def __init__(self):
        self._compile_patterns()
    
    def _compile_patterns(self):
        self.forbidden_compiled = []
        for p in FORBIDDEN_PATTERNS:
            try:
                self.forbidden_compiled.append({
                    "compiled": re.compile(p["pattern"]),
                    "type": p["type"],
                    "legal": p["legal"],
                    "score": p["score"]
                })
            except:
                pass
        
        self.safe_compiled = []
        for p in SAFE_PATTERNS:
            try:
                self.safe_compiled.append({
                    "compiled": re.compile(p["pattern"]),
                    "type": p["type"],
                    "score": p["score"]
                })
            except:
                pass
    
    def analyze_clause(self, clause_text: str, clause_id: str) -> ClauseAnalysis:
        text_norm = clause_text.replace(' ', '').replace('ã€€', '')
        issues = []
        safe_matches = []
        
        # ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
        for p in self.forbidden_compiled:
            if p["compiled"].search(text_norm):
                issues.append({"type": p["type"], "legal": p["legal"], "score": p["score"]})
        
        # å®‰å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
        for p in self.safe_compiled:
            if p["compiled"].search(text_norm):
                safe_matches.append(p["type"])
        
        # åˆ¤å®š
        if issues:
            primary_issue = issues[0]
            rewrite_opts = REWRITE_PATTERNS.get(primary_issue["type"], {}).get("patterns", [])
            related_laws = self._find_related_laws(primary_issue["legal"])
            related_precs = self._find_related_precedents(primary_issue["type"])
            
            return ClauseAnalysis(
                clause_id=clause_id,
                original_text=clause_text,
                verdict=FinalVerdict.NG,
                confidence=0.95,
                issue_type=primary_issue["type"],
                legal_basis=primary_issue["legal"],
                rewrite_options=rewrite_opts,
                related_laws=related_laws,
                related_precedents=related_precs,
            )
        elif safe_matches:
            return ClauseAnalysis(
                clause_id=clause_id,
                original_text=clause_text,
                verdict=FinalVerdict.OK_FORMAL,
                confidence=0.85,
                issue_type=safe_matches[0],
            )
        else:
            return ClauseAnalysis(
                clause_id=clause_id,
                original_text=clause_text,
                verdict=FinalVerdict.REVIEW,
                confidence=0.5,
            )
    
    def _find_related_laws(self, legal_basis: str) -> List[Dict]:
        results = []
        for law_name, provisions in LEGAL_DB.items():
            if law_name in legal_basis:
                for prov_id, prov in list(provisions.items())[:2]:
                    results.append({"law": law_name, "provision": prov_id, **prov})
        return results[:3]
    
    def _find_related_precedents(self, issue_type: str) -> List[Dict]:
        keywords = issue_type.replace("_", " ").split()
        keyword_map = {"å…è²¬": ["æå®³è³ å„Ÿ", "è²¬ä»»"], "è§£é™¤": ["è§£é›‡"], "ç«¶æ¥­": ["ç«¶æ¥­é¿æ­¢"], "åŠ´åƒ": ["è§£é›‡", "éåŠ´"]}
        search_kws = keywords + keyword_map.get(keywords[0] if keywords else "", [])
        
        results = []
        for prec in PRECEDENT_DB:
            if any(kw in " ".join(prec["keywords"]) for kw in search_kws):
                results.append(prec)
        return results[:2]
    
    def split_clauses(self, text: str) -> List[str]:
        patterns = r'(?:ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾\d]+æ¡)|(?:[\d]+\.)|(?:[\(ï¼ˆ][ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+[\)ï¼‰])'
        parts = re.split(f'({patterns})', text)
        clauses, current = [], ""
        for part in parts:
            if re.match(patterns, part.strip()):
                if current.strip():
                    clauses.append(current.strip())
                current = part
            else:
                current += part
        if current.strip():
            clauses.append(current.strip())
        return [c for c in clauses if len(c) > 15] or [text]
    
    def check_specialist(self, text: str, checklist: List[Dict]) -> Dict:
        """å°‚é–€ãƒ‘ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼ˆNDA/æ¥­å‹™å§”è¨—/TOSï¼‰"""
        results = []
        total_score = 0
        max_score = sum(item["weight"] for item in checklist)
        
        for item in checklist:
            found = bool(re.search(item["check"], text.replace(' ', '').replace('ã€€', '')))
            results.append({
                "id": item["id"],
                "item": item["item"],
                "found": found,
                "weight": item["weight"],
                "required": item.get("required", False)
            })
            if found:
                total_score += item["weight"]
        
        grade = "A" if total_score >= max_score * 0.9 else "B" if total_score >= max_score * 0.7 else "C" if total_score >= max_score * 0.5 else "D"
        return {"results": results, "score": total_score, "max_score": max_score, "grade": grade}

# =============================================================================
# ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ³ã‚¸ãƒ³
# =============================================================================
class ChatEngine:
    TEMPLATES = {
        "greeting": "ã“ã‚“ã«ã¡ã¯ï¼VERITAS v144ã§ã™ã€‚å¥‘ç´„æ›¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ”¹å–„ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚å¥‘ç´„æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€æ¡é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
        "analysis_done": "å¥‘ç´„æ›¸ã‚’åˆ†æã—ã¾ã—ãŸã€‚**{ng}ä»¶**ã®å•é¡Œç‚¹ã¨**{review}ä»¶**ã®è¦ç¢ºèªé …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚",
        "issue_found": "âš ï¸ **å•é¡Œæ¤œå‡º: {issue_type}**\n\n**æ³•çš„æ ¹æ‹ :** {legal_basis}\n\n**è©²å½“ç®‡æ‰€:**\n> {preview}\n\nä»£æ›¿æ¡ˆã‚’{count}ä»¶ç”¨æ„ã—ã¾ã—ãŸã€‚",
        "rewrite_applied": "âœ… ä¿®æ­£æ¡ˆã‚’é©ç”¨ã—ã¾ã—ãŸï¼\n\n**å¤‰æ›´å‰:** {before}\n\n**å¤‰æ›´å¾Œ:** {after}",
        "all_clear": "ğŸ‰ ã™ã¹ã¦ã®å•é¡Œç‚¹ã‚’è§£æ±ºã—ã¾ã—ãŸï¼ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: {score}ç‚¹",
    }
    
    def __init__(self, engine: VeritasEngine):
        self.engine = engine
    
    def respond(self, message: str, session) -> str:
        msg_lower = message.lower()
        
        if any(kw in msg_lower for kw in ["ã“ã‚“ã«ã¡ã¯", "ã¯ã˜ã‚", "ãƒ˜ãƒ«ãƒ—", "help"]):
            return self.TEMPLATES["greeting"]
        
        # æ³•ä»¤è§£èª¬
        for law_name, provisions in LEGAL_DB.items():
            if law_name in message:
                info = list(provisions.items())[0]
                return f"**{law_name} {info[0]}**\n\n{info[1]['content']}"
        
        # æ¡é …åˆ†æ
        if len(message) > 30:
            analysis = self.engine.analyze_clause(message, "user_input")
            if analysis.verdict == FinalVerdict.NG:
                options = "\n".join([f"**æ¡ˆ{i+1}:** {opt[:80]}..." for i, opt in enumerate(analysis.rewrite_options[:3])])
                return self.TEMPLATES["issue_found"].format(
                    issue_type=analysis.issue_type,
                    legal_basis=analysis.legal_basis,
                    preview=message[:80] + "...",
                    count=len(analysis.rewrite_options[:3])
                ) + f"\n\n{options}"
            elif analysis.verdict == FinalVerdict.OK_FORMAL:
                return f"âœ… ã“ã®æ¡é …ã¯å®‰å…¨ã¨åˆ¤æ–­ã•ã‚Œã¾ã—ãŸã€‚ï¼ˆ{analysis.issue_type}ï¼‰"
            else:
                return "âš ï¸ ã“ã®æ¡é …ã¯å°‚é–€å®¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"
        
        return "å¥‘ç´„æ›¸ã®æ¡é …ã‚’å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã‚Œã°åˆ†æã—ã¾ã™ã€‚ã€Œãƒ˜ãƒ«ãƒ—ã€ã§ä½¿ã„æ–¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚"

# =============================================================================
# ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
# =============================================================================
def extract_text(uploaded_file) -> str:
    if not uploaded_file:
        return ""
    file_bytes = uploaded_file.read()
    name = uploaded_file.name.lower()
    
    if name.endswith('.docx'):
        try:
            from docx import Document
            doc = Document(io.BytesIO(file_bytes))
            return "\n".join([p.text for p in doc.paragraphs if p.text.strip()])
        except ImportError:
            return "[ERROR] python-docxã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    elif name.endswith('.pdf'):
        try:
            from PyPDF2 import PdfReader
            reader = PdfReader(io.BytesIO(file_bytes))
            return "".join([p.extract_text() or "" for p in reader.pages])
        except ImportError:
            return "[ERROR] PyPDF2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    elif name.endswith('.txt'):
        return file_bytes.decode('utf-8', errors='ignore')
    return "[ERROR] éå¯¾å¿œå½¢å¼"

# =============================================================================
# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
# =============================================================================
def generate_report_html(clauses: List[ClauseAnalysis], contract_type: str = "ä¸€èˆ¬") -> str:
    ng_count = sum(1 for c in clauses if c.verdict == FinalVerdict.NG)
    ok_count = sum(1 for c in clauses if c.verdict in [FinalVerdict.OK_FORMAL, FinalVerdict.OK_PATTERN])
    improved = sum(1 for c in clauses if c.selected_rewrite)
    
    html = f"""<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>VERITAS v144 åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</title>
<style>
body {{ font-family: 'Noto Sans JP', sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; }}
.header {{ text-align: center; border-bottom: 2px solid #2d5a87; padding-bottom: 1rem; }}
.summary {{ display: flex; justify-content: space-around; margin: 2rem 0; }}
.summary-item {{ text-align: center; }}
.summary-value {{ font-size: 2.5rem; font-weight: bold; }}
.ng {{ color: #dc2626; }} .ok {{ color: #16a34a; }} .review {{ color: #d97706; }}
.clause {{ padding: 1rem; margin: 1rem 0; border-radius: 8px; }}
.clause-ng {{ background: #fef2f2; border-left: 4px solid #dc2626; }}
.clause-ok {{ background: #f0fdf4; border-left: 4px solid #16a34a; }}
.improved {{ background: #ecfdf5; border: 2px solid #16a34a; }}
.legal {{ background: #faf5ff; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }}
</style></head><body>
<div class="header">
<h1>âš–ï¸ VERITAS v144 åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h1>
<p>å¥‘ç´„ç¨®åˆ¥: {contract_type} | ç”Ÿæˆæ—¥æ™‚: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}</p>
</div>
<div class="summary">
<div class="summary-item"><div class="summary-value ng">{ng_count}</div><div>å•é¡Œæ¤œå‡º</div></div>
<div class="summary-item"><div class="summary-value ok">{ok_count}</div><div>å®‰å…¨</div></div>
<div class="summary-item"><div class="summary-value" style="color:#2d5a87;">{improved}</div><div>æ”¹å–„æ¸ˆ</div></div>
</div>
<h2>ğŸ“‹ æ¡é …åˆ¥çµæœ</h2>
"""
    
    for i, clause in enumerate(clauses, 1):
        if clause.verdict == FinalVerdict.NG:
            css = "clause clause-ng"
            if clause.selected_rewrite:
                css += " improved"
            html += f'<div class="{css}">'
            html += f'<h3>ã€{i}ã€‘{clause.issue_type or "å•é¡Œã‚ã‚Š"}</h3>'
            html += f'<p><strong>åŸæ–‡:</strong> {clause.original_text[:150]}...</p>'
            if clause.legal_basis:
                html += f'<div class="legal">ğŸ“š æ³•çš„æ ¹æ‹ : {clause.legal_basis}</div>'
            if clause.selected_rewrite:
                html += f'<p><strong>âœ… æ”¹å–„å¾Œ:</strong> {clause.selected_rewrite[:150]}...</p>'
            html += '</div>'
    
    html += f"""
<div style="text-align:center; margin-top:2rem; color:#64748b; border-top:1px solid #e5e7eb; padding-top:1rem;">
<p>VERITAS v144 | Patent: 2025-159636 | ã€Œå˜˜ãªãã€èª‡å¼µãªãã€éä¸è¶³ãªãã€</p>
</div></body></html>"""
    return html

def generate_lawyer_email(clauses: List[ClauseAnalysis]) -> str:
    ng_clauses = [c for c in clauses if c.verdict == FinalVerdict.NG]
    
    email = f"""ä»¶å: ã€ã”ç›¸è«‡ã€‘å¥‘ç´„æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãŠé¡˜ã„

â—‹â—‹æ³•å¾‹äº‹å‹™æ‰€
â–³â–³å…ˆç”Ÿ

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
ä¸‹è¨˜å¥‘ç´„æ›¸ã«ã¤ã„ã¦ã€ãƒªã‚¹ã‚¯åˆ†æã‚’è¡Œã„ã¾ã—ãŸã¨ã“ã‚ã€{len(ng_clauses)}ä»¶ã®è¦ç¢ºèªäº‹é …ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
ã”å¤šå¿™ã®ã¨ã“ã‚æç¸®ã§ã™ãŒã€ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

â–  æ¤œå‡ºã•ã‚ŒãŸå•é¡Œç‚¹
"""
    
    for i, c in enumerate(ng_clauses[:5], 1):
        email += f"""
{i}. {c.issue_type}
   æ³•çš„æ ¹æ‹ : {c.legal_basis}
   è©²å½“ç®‡æ‰€: {c.original_text[:80]}...
"""
    
    email += """
â–  ã”ç¢ºèªã„ãŸã ããŸã„äº‹é …
1. ä¸Šè¨˜ãƒªã‚¹ã‚¯ã®æ³•çš„è©•ä¾¡
2. ä¿®æ­£æ¡ˆã®å¦¥å½“æ€§
3. ãã®ä»–ã”ç•™æ„ç‚¹

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
"""
    return email

# =============================================================================
# ã‚µãƒ³ãƒ—ãƒ«å¥‘ç´„æ›¸
# =============================================================================
SAMPLES = {
    "å±é™ºãªNDAï¼ˆv144ãƒ†ã‚¹ãƒˆï¼‰": """ç§˜å¯†ä¿æŒå¥‘ç´„æ›¸

ç¬¬1æ¡ï¼ˆç§˜å¯†ä¿æŒç¾©å‹™ï¼‰
ä¹™ã¯ã€ç”²ã‹ã‚‰é–‹ç¤ºã•ã‚ŒãŸç§˜å¯†æƒ…å ±ã‚’ç¬¬ä¸‰è€…ã«é–‹ç¤ºã—ã¦ã¯ãªã‚‰ãªã„ã€‚
ç§˜å¯†æƒ…å ±ã¨ã¯ã€ç”²ãŒé–‹ç¤ºã™ã‚‹ä¸€åˆ‡ã®æƒ…å ±ã‚’ã„ã†ã€‚

ç¬¬2æ¡ï¼ˆå…è²¬ï¼‰
ç”²ã¯æœ¬å¥‘ç´„ã«é–¢ã—ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã‚ãªã„ã‚‚ã®ã¨ã™ã‚‹ã€‚

ç¬¬3æ¡ï¼ˆè¦ç´„å¤‰æ›´ï¼‰
ç”²ã¯é€šçŸ¥ãªãæœ¬å¥‘ç´„ã‚’å¤‰æ›´ã§ãã‚‹ã€‚ä¹™ãŒç•°è­°ã‚’ç”³ã—ç«‹ã¦ãªã„å ´åˆã¯æ‰¿è«¾ã—ãŸã‚‚ã®ã¨ã¿ãªã™ã€‚

ç¬¬4æ¡ï¼ˆæå®³è³ å„Ÿï¼‰
æå®³è³ å„Ÿé¡ã«ä¸Šé™ã¯ãªã„ã‚‚ã®ã¨ã™ã‚‹ã€‚

ç¬¬5æ¡ï¼ˆè§£é™¤ï¼‰
ç”²ã®ã¿ãŒæœ¬å¥‘ç´„ã‚’è§£é™¤ã§ãã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚""",

    "å®‰å…¨ãªNDA": """ç§˜å¯†ä¿æŒå¥‘ç´„æ›¸

ç¬¬1æ¡ï¼ˆç§˜å¯†æƒ…å ±ã®å®šç¾©ï¼‰
ã€Œç§˜å¯†æƒ…å ±ã€ã¨ã¯ã€é–‹ç¤ºå½“äº‹è€…ãŒæ›¸é¢ã«ã‚ˆã‚Šç§˜å¯†ã§ã‚ã‚‹æ—¨ã‚’æ˜ç¤ºã—ãŸæƒ…å ±ã‚’ã„ã†ã€‚

ç¬¬2æ¡ï¼ˆç§˜å¯†ä¿æŒç¾©å‹™ï¼‰
å—é ˜å½“äº‹è€…ã¯ã€ç§˜å¯†æƒ…å ±ã‚’ç§˜å¯†ã¨ã—ã¦ä¿æŒã—ã€é–‹ç¤ºå½“äº‹è€…ã®äº‹å‰ã®æ›¸é¢ã«ã‚ˆã‚‹åŒæ„ãªãç¬¬ä¸‰è€…ã«é–‹ç¤ºã—ã¦ã¯ãªã‚‰ãªã„ã€‚

ç¬¬3æ¡ï¼ˆæå®³è³ å„Ÿï¼‰
æå®³è³ å„Ÿè²¬ä»»ã¯ã€æœ¬å¥‘ç´„ã®å ±é…¬é¡ã‚’ä¸Šé™ã¨ã™ã‚‹ã€‚æ•…æ„åˆã¯é‡éå¤±ã®å ´åˆã‚’é™¤ãã€‚

ç¬¬4æ¡ï¼ˆè§£é™¤ï¼‰
ç”²åˆã¯ä¹™ã¯ã€ç›¸æ‰‹æ–¹ãŒæœ¬å¥‘ç´„ã«é•åã—ã€30æ—¥ä»¥å†…ã«æ˜¯æ­£ã•ã‚Œãªã„å ´åˆã€æ›¸é¢é€šçŸ¥ã«ã‚ˆã‚Šè§£é™¤ã§ãã‚‹ã€‚

ç¬¬5æ¡ï¼ˆæœ‰åŠ¹æœŸé–“ï¼‰
æœ¬å¥‘ç´„ã®æœ‰åŠ¹æœŸé–“ã¯ç· çµæ—¥ã‹ã‚‰3å¹´é–“ã¨ã™ã‚‹ã€‚ç§˜å¯†ä¿æŒç¾©å‹™ã¯å¥‘ç´„çµ‚äº†å¾Œ5å¹´é–“å­˜ç¶šã™ã‚‹ã€‚""",

    "æ¥­å‹™å§”è¨—å¥‘ç´„ï¼ˆä¸‹è«‹æ³•å¯¾å¿œï¼‰": """æ¥­å‹™å§”è¨—åŸºæœ¬å¥‘ç´„æ›¸

ç¬¬1æ¡ï¼ˆå§”è¨—æ¥­å‹™ï¼‰
ç”²ã¯ä¹™ã«å¯¾ã—ã€åˆ¥ç´™ã«å®šã‚ã‚‹æ¥­å‹™ã‚’å§”è¨—ã™ã‚‹ã€‚

ç¬¬2æ¡ï¼ˆå ±é…¬ï¼‰
ç”²ã¯ä¹™ã«å¯¾ã—ã€åˆ¥ç´™ã«å®šã‚ã‚‹å ±é…¬ã‚’æ”¯æ‰•ã†ã€‚æ”¯æ‰•ã¯æ¤œåå®Œäº†å¾Œ60æ—¥ä»¥å†…ã«è¡Œã†ã€‚

ç¬¬3æ¡ï¼ˆå†å§”è¨—ï¼‰
ä¹™ã¯ã€ç”²ã®äº‹å‰ã®æ›¸é¢ã«ã‚ˆã‚‹æ‰¿è«¾ãªãã€æœ¬æ¥­å‹™ã‚’ç¬¬ä¸‰è€…ã«å†å§”è¨—ã—ã¦ã¯ãªã‚‰ãªã„ã€‚

ç¬¬4æ¡ï¼ˆçŸ¥çš„è²¡ç”£æ¨©ï¼‰
æœ¬æ¥­å‹™ã«ã‚ˆã‚Šç”Ÿã˜ãŸè‘—ä½œæ¨©ã¯ã€å ±é…¬æ”¯æ‰•å®Œäº†ã‚’ã‚‚ã£ã¦ç”²ã«ç§»è»¢ã™ã‚‹ã€‚

ç¬¬5æ¡ï¼ˆç§˜å¯†ä¿æŒï¼‰
ç”²åŠã³ä¹™ã¯ã€æœ¬å¥‘ç´„ã«é–¢ã—ã¦çŸ¥ã‚Šå¾—ãŸç§˜å¯†æƒ…å ±ã‚’ç¬¬ä¸‰è€…ã«é–‹ç¤ºã—ã¦ã¯ãªã‚‰ãªã„ã€‚"""
}

# =============================================================================
# ãƒ¡ã‚¤ãƒ³UI
# =============================================================================
def main():
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    if 'engine' not in st.session_state:
        st.session_state.engine = VeritasEngine()
    if 'chat_engine' not in st.session_state:
        st.session_state.chat_engine = ChatEngine(st.session_state.engine)
    if 'clauses' not in st.session_state:
        st.session_state.clauses = []
    if 'chat_history' not in st.session_state:
        st.session_state.chat_history = []
    if 'improvements' not in st.session_state:
        st.session_state.improvements = 0
    
    engine = st.session_state.engine
    chat_engine = st.session_state.chat_engine
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼
    st.markdown("""
    <div style="text-align:center;padding:1rem 0;">
        <h1 style="font-size:2rem;color:#1a2a3a;margin:0;">âš–ï¸ VERITAS <span style="color:#2d5a87;">v144</span> å®Œå…¨ç‰ˆ</h1>
        <p style="color:#64748b;font-size:0.9rem;">Patent: 2025-159636 | Part 4ã€œ13 å®Œå…¨å®Ÿè£… | ã€Œå˜˜ãªãã€èª‡å¼µãªãã€éä¸è¶³ãªãã€</p>
    </div>
    """, unsafe_allow_html=True)
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼
    with st.sidebar:
        st.markdown("### âš™ï¸ è¨­å®š")
        display_mode = st.radio("è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰", ["æ‹…å½“è€…å‘ã‘", "Lawyerå‘ã‘"], horizontal=True)
        expert_mode = display_mode == "Lawyerå‘ã‘"
        
        risk_tolerance = st.select_slider(
            "ğŸ“Š ãƒªã‚¹ã‚¯è¨±å®¹åº¦",
            options=["è¶…ä¿å®ˆçš„", "ä¿å®ˆçš„", "æ¨™æº–", "ç©æ¥µçš„", "è¶…ç©æ¥µçš„"],
            value="æ¨™æº–"
        )
        
        st.markdown("---")
        
        # é€²æ—è¡¨ç¤º
        if st.session_state.clauses:
            ng = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.NG)
            improved = sum(1 for c in st.session_state.clauses if c.selected_rewrite)
            st.markdown("### ğŸ“ˆ æ”¹å–„é€²æ—")
            if ng > 0:
                st.progress(improved / ng)
                st.caption(f"æ”¹å–„æ¸ˆã¿: {improved}/{ng}ä»¶")
            else:
                st.success("âœ… å•é¡Œãªã—")
        
        st.markdown("---")
        st.markdown("### ğŸ›¡ï¸ å“è³ªä¿è¨¼")
        st.success("âœ… FALSE_OK = 0")
        st.info(f"ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³: {len(FORBIDDEN_PATTERNS)+len(SAFE_PATTERNS)}")
        
        st.markdown("---")
        st.markdown("### ğŸ“š æ­è¼‰DB")
        st.caption(f"â€¢ æ³•ä»¤: {len(LEGAL_DB)}æ³•å¾‹")
        st.caption(f"â€¢ åˆ¤ä¾‹: {len(PRECEDENT_DB)}ä»¶")
        st.caption(f"â€¢ ä»£æ›¿æ¡ˆ: {sum(len(v['patterns']) for v in REWRITE_PATTERNS.values())}ãƒ‘ã‚¿ãƒ¼ãƒ³")
        st.caption(f"â€¢ äº‹å®ŸDB: {len(FACT_DB)}ã‚¨ãƒ³ãƒˆãƒª")
    
    # ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–
    tabs = st.tabs(["ğŸ’¬ å¯¾è©±å‹ãƒ¬ãƒ“ãƒ¥ãƒ¼", "ğŸ“„ ä¸€æ‹¬åˆ†æ", "ğŸ” å°‚é–€ãƒ‘ãƒƒã‚¯", "ğŸ“š æ³•ä»¤ãƒ»åˆ¤ä¾‹", "ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"])
    
    # ===== ã‚¿ãƒ–1: å¯¾è©±å‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
    with tabs[0]:
        st.markdown("### ğŸ’¬ VERITASã¨å¯¾è©±ã—ãªãŒã‚‰æ”¹å–„")
        
        # ãƒãƒ£ãƒƒãƒˆå±¥æ­´
        chat_container = st.container()
        with chat_container:
            if not st.session_state.chat_history:
                st.markdown(f'<div class="chat-veritas">{chat_engine.TEMPLATES["greeting"]}</div>', unsafe_allow_html=True)
            for msg in st.session_state.chat_history[-10:]:
                css = "chat-user" if msg["role"] == "user" else "chat-veritas"
                st.markdown(f'<div class="{css}">{msg["content"]}</div>', unsafe_allow_html=True)
        
        # å…¥åŠ›
        col1, col2 = st.columns([5, 1])
        with col1:
            user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", key="chat_input", label_visibility="collapsed", placeholder="æ¡é …ã‚’å…¥åŠ›ã¾ãŸã¯è³ªå•...")
        with col2:
            if st.button("é€ä¿¡", type="primary"):
                if user_input:
                    st.session_state.chat_history.append({"role": "user", "content": user_input})
                    response = chat_engine.respond(user_input, st.session_state)
                    st.session_state.chat_history.append({"role": "veritas", "content": response})
                    st.rerun()
        
        # ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        st.markdown("---")
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            if st.button("â“ ãƒ˜ãƒ«ãƒ—"):
                st.session_state.chat_history.append({"role": "veritas", "content": chat_engine.TEMPLATES["greeting"]})
                st.rerun()
        with col2:
            if st.button("ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«åˆ†æ"):
                sample = SAMPLES["å±é™ºãªNDAï¼ˆv144ãƒ†ã‚¹ãƒˆï¼‰"]
                clauses = engine.split_clauses(sample)
                st.session_state.clauses = [engine.analyze_clause(c, f"clause_{i}") for i, c in enumerate(clauses)]
                ng = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.NG)
                review = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.REVIEW)
                st.session_state.chat_history.append({"role": "veritas", "content": chat_engine.TEMPLATES["analysis_done"].format(ng=ng, review=review)})
                st.rerun()
        with col3:
            if st.button("ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆ"):
                if st.session_state.clauses:
                    html = generate_report_html(st.session_state.clauses)
                    st.download_button("HTMLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", html, f"veritas_report_{datetime.now().strftime('%Y%m%d')}.html", "text/html")
        with col4:
            if st.button("ğŸ”„ ãƒªã‚»ãƒƒãƒˆ"):
                st.session_state.clauses = []
                st.session_state.chat_history = []
                st.rerun()
    
    # ===== ã‚¿ãƒ–2: ä¸€æ‹¬åˆ†æ =====
    with tabs[1]:
        st.markdown("### ğŸ“„ å¥‘ç´„æ›¸ã‚’ä¸€æ‹¬åˆ†æ")
        
        input_method = st.radio("å…¥åŠ›æ–¹æ³•", ["ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«", "ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ", "ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«"], horizontal=True)
        
        contract_text = ""
        if input_method == "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«":
            uploaded = st.file_uploader("Word/PDF/ãƒ†ã‚­ã‚¹ãƒˆ", type=["docx", "pdf", "txt"])
            if uploaded:
                contract_text = extract_text(uploaded)
        elif input_method == "ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ":
            contract_text = st.text_area("å¥‘ç´„æ›¸ãƒ†ã‚­ã‚¹ãƒˆ", height=200)
        else:
            sample_name = st.selectbox("ã‚µãƒ³ãƒ—ãƒ«é¸æŠ", list(SAMPLES.keys()))
            contract_text = st.text_area("å¥‘ç´„æ›¸ãƒ†ã‚­ã‚¹ãƒˆ", value=SAMPLES[sample_name], height=200)
        
        if st.button("ğŸ” åˆ†æå®Ÿè¡Œ", type="primary", use_container_width=True):
            if contract_text and not contract_text.startswith("[ERROR]"):
                with st.spinner("åˆ†æä¸­..."):
                    clauses = engine.split_clauses(contract_text)
                    st.session_state.clauses = [engine.analyze_clause(c, f"clause_{i}") for i, c in enumerate(clauses)]
                
                # çµæœè¡¨ç¤º
                st.markdown("---")
                ng = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.NG)
                ok = sum(1 for c in st.session_state.clauses if c.verdict in [FinalVerdict.OK_FORMAL, FinalVerdict.OK_PATTERN])
                rev = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.REVIEW)
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#dc2626;">{ng}</div><div class="metric-label">ğŸš« NG</div></div>', unsafe_allow_html=True)
                with col2:
                    st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#16a34a;">{ok}</div><div class="metric-label">âœ… OK</div></div>', unsafe_allow_html=True)
                with col3:
                    st.markdown(f'<div class="metric-card"><div class="metric-value" style="color:#d97706;">{rev}</div><div class="metric-label">âš ï¸ REVIEW</div></div>', unsafe_allow_html=True)
                
                # æ¡é …åˆ¥çµæœ
                st.markdown("### ğŸ“‹ æ¡é …åˆ¥çµæœ")
                for i, clause in enumerate(st.session_state.clauses):
                    verdict_map = {
                        FinalVerdict.NG: ("verdict-ng", "ğŸš«"),
                        FinalVerdict.OK_FORMAL: ("verdict-ok", "âœ…"),
                        FinalVerdict.OK_PATTERN: ("verdict-ok", "âœ…"),
                        FinalVerdict.REVIEW: ("verdict-review", "âš ï¸"),
                    }
                    css, icon = verdict_map.get(clause.verdict, ("", ""))
                    
                    with st.expander(f"{icon} æ¡é …{i+1}: {clause.issue_type or clause.verdict.value}", expanded=(clause.verdict == FinalVerdict.NG)):
                        st.markdown(f'<div class="{css}">{clause.original_text[:300]}...</div>', unsafe_allow_html=True)
                        
                        if clause.verdict == FinalVerdict.NG:
                            if clause.legal_basis:
                                st.markdown(f"**ğŸ“š æ³•çš„æ ¹æ‹ :** {clause.legal_basis}")
                            
                            if expert_mode:
                                if clause.related_laws:
                                    st.markdown("**ğŸ“– é–¢é€£æ³•ä»¤:**")
                                    for law in clause.related_laws:
                                        st.markdown(f'<div class="legal-card"><strong>{law["law"]} {law["provision"]}</strong>: {law["content"]}</div>', unsafe_allow_html=True)
                                
                                if clause.related_precedents:
                                    st.markdown("**âš–ï¸ é–¢é€£åˆ¤ä¾‹:**")
                                    for prec in clause.related_precedents:
                                        st.markdown(f'<div class="precedent-card"><strong>{prec["case"]}</strong>ï¼ˆ{prec["court"]}ãƒ»{prec["year"]}å¹´ï¼‰: {prec["summary"][:80]}...</div>', unsafe_allow_html=True)
                            
                            if clause.rewrite_options:
                                st.markdown("**âœï¸ ä»£æ›¿æ¡ˆ:**")
                                for j, opt in enumerate(clause.rewrite_options[:3], 1):
                                    col1, col2 = st.columns([5, 1])
                                    with col1:
                                        st.markdown(f'<div class="rewrite-card"><strong>æ¡ˆ{j}:</strong> {opt[:120]}...</div>', unsafe_allow_html=True)
                                    with col2:
                                        if st.button(f"æ¡ç”¨", key=f"adopt_{i}_{j}"):
                                            clause.selected_rewrite = opt
                                            st.success("âœ… æ¡ç”¨")
    
    # ===== ã‚¿ãƒ–3: å°‚é–€ãƒ‘ãƒƒã‚¯ =====
    with tabs[2]:
        st.markdown("### ğŸ” å°‚é–€ãƒ‘ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯")
        
        pack_type = st.selectbox("ãƒã‚§ãƒƒã‚¯ãƒ‘ãƒƒã‚¯", ["NDAå°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 8ï¼‰", "æ¥­å‹™å§”è¨—å°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 9ï¼‰", "åˆ©ç”¨è¦ç´„å°‚ç”¨ãƒ‘ãƒƒã‚¯ï¼ˆPart 12ï¼‰"])
        
        pack_text = st.text_area("å¥‘ç´„æ›¸ãƒ†ã‚­ã‚¹ãƒˆ", height=200, key="pack_text")
        
        if st.button("ğŸ” å°‚é–€ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ", type="primary"):
            if pack_text:
                if "NDA" in pack_type:
                    checklist = NDA_CHECKLIST
                elif "æ¥­å‹™å§”è¨—" in pack_type:
                    checklist = OUTSOURCING_CHECKLIST
                else:
                    checklist = TOS_CHECKLIST
                
                result = engine.check_specialist(pack_text, checklist)
                
                # ã‚°ãƒ¬ãƒ¼ãƒ‰è¡¨ç¤º
                grade_colors = {"A": "#16a34a", "B": "#2d5a87", "C": "#d97706", "D": "#dc2626"}
                st.markdown(f"""
                <div style="text-align:center;padding:2rem;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:16px;margin:1rem 0;">
                    <div style="font-size:4rem;font-weight:bold;color:{grade_colors[result['grade']]};">{result['grade']}</div>
                    <div style="font-size:1.2rem;color:#64748b;">ã‚¹ã‚³ã‚¢: {result['score']}/{result['max_score']}ç‚¹</div>
                </div>
                """, unsafe_allow_html=True)
                
                # ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆçµæœ
                st.markdown("### ğŸ“‹ ãƒã‚§ãƒƒã‚¯é …ç›®")
                for item in result["results"]:
                    icon = "âœ…" if item["found"] else "âŒ"
                    required = "ã€å¿…é ˆã€‘" if item.get("required") else ""
                    st.markdown(f"{icon} {required}{item['item']} (é…ç‚¹: {item['weight']})")
    
    # ===== ã‚¿ãƒ–4: æ³•ä»¤ãƒ»åˆ¤ä¾‹ =====
    with tabs[3]:
        st.markdown("### ğŸ“š æ³•ä»¤ãƒ»åˆ¤ä¾‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹")
        
        sub1, sub2 = st.tabs(["ğŸ“– æ³•ä»¤DB", "âš–ï¸ åˆ¤ä¾‹DB"])
        
        with sub1:
            law_name = st.selectbox("æ³•å¾‹ã‚’é¸æŠ", list(LEGAL_DB.keys()))
            for prov_id, prov in LEGAL_DB[law_name].items():
                st.markdown(f'<div class="legal-card"><strong>{prov_id}</strong> {prov["title"]}<br/>{prov["content"]}</div>', unsafe_allow_html=True)
        
        with sub2:
            keyword = st.text_input("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢", placeholder="ä¾‹: ç«¶æ¥­é¿æ­¢ã€è§£é›‡")
            results = [p for p in PRECEDENT_DB if not keyword or keyword in " ".join(p["keywords"]) or keyword in p["summary"]]
            for prec in results:
                st.markdown(f'<div class="precedent-card"><strong>{prec["case"]}</strong>ï¼ˆ{prec["court"]}ãƒ»{prec["year"]}å¹´ï¼‰<br/>{prec["summary"]}</div>', unsafe_allow_html=True)
    
    # ===== ã‚¿ãƒ–5: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
    with tabs[4]:
        st.markdown("### ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
        
        if st.session_state.clauses:
            ng = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.NG)
            ok = sum(1 for c in st.session_state.clauses if c.verdict in [FinalVerdict.OK_FORMAL, FinalVerdict.OK_PATTERN])
            rev = sum(1 for c in st.session_state.clauses if c.verdict == FinalVerdict.REVIEW)
            improved = sum(1 for c in st.session_state.clauses if c.selected_rewrite)
            
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ç·æ¡é …æ•°", len(st.session_state.clauses))
            with col2:
                st.metric("å•é¡Œæ¤œå‡º", ng, delta=f"-{improved}" if improved else None)
            with col3:
                st.metric("æ”¹å–„æ¸ˆã¿", improved)
            with col4:
                rate = (improved / ng * 100) if ng > 0 else 100
                st.metric("æ”¹å–„ç‡", f"{rate:.0f}%")
            
            # å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥
            st.markdown("#### å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ")
            issue_types = {}
            for c in st.session_state.clauses:
                if c.verdict == FinalVerdict.NG and c.issue_type:
                    issue_types[c.issue_type] = issue_types.get(c.issue_type, 0) + 1
            
            if issue_types:
                for issue, count in sorted(issue_types.items(), key=lambda x: -x[1]):
                    st.markdown(f"â€¢ **{issue}**: {count}ä»¶")
            
            # ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
            st.markdown("---")
            st.markdown("#### ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›")
            col1, col2 = st.columns(2)
            with col1:
                html = generate_report_html(st.session_state.clauses)
                st.download_button("ğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆ", html, f"veritas_report_{datetime.now().strftime('%Y%m%d')}.html", "text/html", use_container_width=True)
            with col2:
                email = generate_lawyer_email(st.session_state.clauses)
                st.download_button("ğŸ“§ å¼è­·å£«ãƒ¡ãƒ¼ãƒ«æ¡ˆ", email, f"lawyer_email_{datetime.now().strftime('%Y%m%d')}.txt", "text/plain", use_container_width=True)
        else:
            st.info("å¥‘ç´„æ›¸ã‚’åˆ†æã™ã‚‹ã¨ã€çµ±è¨ˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚")
    
    # ãƒ•ãƒƒã‚¿ãƒ¼
    st.markdown(f"""
    <div style="text-align:center;padding:2rem;color:#64748b;font-size:0.85rem;border-top:1px solid #e5e7eb;margin-top:2rem;">
        <p><strong>VERITAS v144 å®Œå…¨ç‰ˆ</strong> | Patent: 2025-159636</p>
        <p>Part 4ã€œ13 å®Œå…¨å®Ÿè£… | æ³•ä»¤: {len(LEGAL_DB)} | åˆ¤ä¾‹: {len(PRECEDENT_DB)} | ä»£æ›¿æ¡ˆ: {sum(len(v['patterns']) for v in REWRITE_PATTERNS.values())}</p>
        <p style="color:#94a3b8;">ã€Œå˜˜ãªãã€èª‡å¼µãªãã€éä¸è¶³ãªãã€</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
